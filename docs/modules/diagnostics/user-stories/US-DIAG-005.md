# US-DIAG-005: Aprovar Diagn√≥stico e Gerar Or√ßamento

**ID:** US-DIAG-005  
**Epic:** Diagn√≥sticos  
**Sprint:** 3  
**Prioridade:** Cr√≠tica  
**Estimativa:** 8 pontos  
**Status:** Done  

---

## üìã User Story

**Como** t√©cnico/gerente  
**Quero** aprovar o diagn√≥stico completo e gerar automaticamente um or√ßamento  
**Para** agilizar o processo de venda e reduzir retrabalho

---

## üéØ Business Objective

Criar transi√ß√£o fluida entre diagn√≥stico e or√ßamento, eliminando digita√ß√£o manual e reduzindo tempo de resposta ao cliente.

---

## üìê Business Rules

### RN001: Pr√©-requisitos para Aprova√ß√£o
```typescript
const canApproveDiagnostic = (responses: DiagnosticResponse[]) => {
  const checks = {
    // Todos os componentes da OS foram diagnosticados
    all_components_diagnosed: responses.length === order.required_components.length,
    
    // Todos os campos obrigat√≥rios preenchidos
    all_required_answered: responses.every(r => r.status === 'completed'),
    
    // Pelo menos 1 servi√ßo sugerido selecionado
    has_selected_services: responses.some(r => 
      r.response_items.some(i => i.suggested_services.length > 0)
    ),
    
    // T√©cnico ou gerente
    has_permission: user.role in ['tecnico', 'gerente', 'admin']
  };
  
  return Object.values(checks).every(check => check === true);
};
```

### RN002: Fluxo de Aprova√ß√£o
```mermaid
graph TD
    A[Diagn√≥stico Completo] --> B{Validar Pr√©-requisitos}
    B -->|Falha| C[Mostrar Erros]
    B -->|OK| D[Modal de Revis√£o]
    D --> E{Confirmar Aprova√ß√£o?}
    E -->|N√£o| F[Voltar para Edi√ß√£o]
    E -->|Sim| G[Atualizar Status = approved]
    G --> H[Consolidar Servi√ßos]
    H --> I[Criar Rascunho de Or√ßamento]
    I --> J[Atualizar Workflow = aguardando_orcamento]
    J --> K[Redirecionar para Or√ßamentos]
```

### RN003: Consolida√ß√£o de Servi√ßos
```typescript
const consolidateServices = (responses: DiagnosticResponse[]) => {
  const allServices: ServiceItem[] = [];
  
  responses.forEach(response => {
    response.response_items.forEach(item => {
      item.suggested_services.forEach(serviceCode => {
        // Busca detalhes do servi√ßo no cat√°logo
        const service = serviceCatalog.find(s => s.service_code === serviceCode);
        
        allServices.push({
          component: response.component,
          service_code: serviceCode,
          service_name: service.service_name,
          base_price: service.base_price,
          quantity: 1,
          unit: service.unit,
          estimated_time_hours: service.estimated_time_hours,
          requires_parts: service.requires_parts,
          diagnostic_item_id: item.id
        });
      });
    });
  });
  
  // Remove duplicatas (mesmo servi√ßo no mesmo componente)
  return allServices.reduce((acc, service) => {
    const existing = acc.find(s => 
      s.service_code === service.service_code && 
      s.component === service.component
    );
    
    if (existing) {
      existing.quantity += 1;
    } else {
      acc.push(service);
    }
    
    return acc;
  }, [] as ServiceItem[]);
};
```

### RN004: Cria√ß√£o de Or√ßamento
```typescript
const createBudgetFromDiagnostic = async (
  orderId: string,
  diagnosticResponses: DiagnosticResponse[]
) => {
  const services = consolidateServices(diagnosticResponses);
  
  // Cria um detailed_budget para cada componente
  const budgets = await Promise.all(
    services.map(async (service) => {
      return supabase
        .from('detailed_budgets')
        .insert({
          order_id: orderId,
          component: service.component,
          diagnostic_response_id: diagnosticResponses.find(
            r => r.component === service.component
          )?.id,
          status: 'draft',
          services: [service],
          parts: [], // Vazio inicialmente
          subtotal: service.base_price * service.quantity,
          discount_percentage: 0,
          tax_percentage: 0
        })
        .select()
        .single();
    })
  );
  
  return budgets;
};
```

### RN005: Modal de Revis√£o
**Informa√ß√µes exibidas:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìã REVISAR DIAGN√ìSTICO - OS #1234                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ Componentes Diagnosticados: 7/7 ‚úÖ                      ‚îÇ
‚îÇ Campos Preenchidos: 89/92 (97%)                         ‚îÇ
‚îÇ Servi√ßos Sugeridos: 12                                  ‚îÇ
‚îÇ Servi√ßos Selecionados: 9                                ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ ‚îÇ RESUMO POR COMPONENTE:                            ‚îÇ  ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ
‚îÇ ‚îÇ                                                    ‚îÇ  ‚îÇ
‚îÇ ‚îÇ ‚úÖ Bloco (4 servi√ßos - R$ 2.550,00)               ‚îÇ  ‚îÇ
‚îÇ ‚îÇ    ‚Ä¢ Ret√≠fica de camisa                           ‚îÇ  ‚îÇ
‚îÇ ‚îÇ    ‚Ä¢ Soldagem de trinca                           ‚îÇ  ‚îÇ
‚îÇ ‚îÇ    ‚Ä¢ Usinagem do bloco                            ‚îÇ  ‚îÇ
‚îÇ ‚îÇ    ‚Ä¢ Limpeza profunda                             ‚îÇ  ‚îÇ
‚îÇ ‚îÇ                                                    ‚îÇ  ‚îÇ
‚îÇ ‚îÇ ‚úÖ Cabe√ßote (2 servi√ßos - R$ 830,00)              ‚îÇ  ‚îÇ
‚îÇ ‚îÇ ‚úÖ Virabrequim (1 servi√ßo - R$ 950,00)            ‚îÇ  ‚îÇ
‚îÇ ‚îÇ ‚úÖ Biela (1 servi√ßo - R$ 180,00)                  ‚îÇ  ‚îÇ
‚îÇ ‚îÇ ‚úÖ Pist√£o (1 servi√ßo - R$ 350,00)                 ‚îÇ  ‚îÇ
‚îÇ ‚îÇ ‚úÖ Comando (0 servi√ßos)                            ‚îÇ  ‚îÇ
‚îÇ ‚îÇ ‚úÖ Eixo (0 servi√ßos)                               ‚îÇ  ‚îÇ
‚îÇ ‚îÇ                                                    ‚îÇ  ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ Valor Total Estimado: R$ 4.860,00                       ‚îÇ
‚îÇ Tempo Total Estimado: 18.5 horas                        ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ ‚ö†Ô∏è Observa√ß√µes:                                         ‚îÇ
‚îÇ ‚Ä¢ Comando e Eixo n√£o necessitam servi√ßos               ‚îÇ
‚îÇ ‚Ä¢ 3 campos opcionais n√£o foram preenchidos             ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ Ao aprovar, um or√ßamento rascunho ser√° criado          ‚îÇ
‚îÇ automaticamente com estes servi√ßos.                    ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ          [Cancelar]  [‚úÖ Aprovar e Gerar Or√ßamento]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### RN006: P√≥s-Aprova√ß√£o
**A√ß√µes Autom√°ticas:**
1. Atualizar `diagnostic_responses.status` = `'approved'`
2. Registrar `diagnostic_responses.approved_by` = `auth.uid()`
3. Registrar `diagnostic_responses.approved_at` = `now()`
4. Criar registros em `detailed_budgets` (um por componente)
5. Atualizar `order_workflow.current_stage` = `'aguardando_orcamento'`
6. Criar notifica√ß√£o para gerente: "Diagn√≥stico aprovado - Criar or√ßamento"
7. Redirecionar para p√°gina de or√ßamentos

---

## ‚úÖ Acceptance Criteria

**AC1:** Bot√£o "Aprovar Diagn√≥stico" fica habilitado apenas quando pr√©-requisitos OK  
**AC2:** Modal de revis√£o mostra resumo completo  
**AC3:** Ao aprovar, or√ßamento rascunho √© criado automaticamente  
**AC4:** Status do diagn√≥stico muda para "approved"  
**AC5:** Workflow da OS muda para "aguardando_orcamento"  
**AC6:** Gerente recebe notifica√ß√£o  
**AC7:** Sou redirecionado para p√°gina de or√ßamentos

---

## üõ†Ô∏è Definition of Done

- [x] Bot√£o "Aprovar Diagn√≥stico" implementado
- [x] Modal de revis√£o criado
- [x] Fun√ß√£o `consolidateServices()` implementada
- [x] Fun√ß√£o `createBudgetFromDiagnostic()` implementada
- [x] Transi√ß√£o de workflow autom√°tica
- [x] Notifica√ß√µes configuradas
- [x] Redirecionamento funcional
- [x] Testes E2E escritos

---

## üìÅ Affected Components

```
src/components/diagnostics/
  ‚îú‚îÄ‚îÄ DiagnosticWizard.tsx         (UPDATE - bot√£o aprovar)
  ‚îú‚îÄ‚îÄ DiagnosticReview.tsx         (NEW - modal revis√£o)
  ‚îî‚îÄ‚îÄ ApprovalButton.tsx           (NEW)

src/hooks/
  ‚îú‚îÄ‚îÄ useDiagnosticResponses.ts    (UPDATE - approve function)
  ‚îî‚îÄ‚îÄ useCreateBudget.ts           (NEW)
```

---

## üóÑÔ∏è Database Changes

```sql
-- Fun√ß√£o para aprovar diagn√≥stico e criar or√ßamento
CREATE OR REPLACE FUNCTION approve_diagnostic_and_create_budget(
  p_order_id UUID
) RETURNS jsonb AS $$
DECLARE
  v_responses RECORD;
  v_budget_ids UUID[];
  v_service RECORD;
BEGIN
  -- Valida se todos os componentes foram diagnosticados
  IF (
    SELECT COUNT(*) FROM diagnostic_responses 
    WHERE order_id = p_order_id AND status != 'completed'
  ) > 0 THEN
    RAISE EXCEPTION 'Nem todos os componentes foram diagnosticados completamente';
  END IF;
  
  -- Atualiza status dos diagn√≥sticos
  UPDATE diagnostic_responses
  SET 
    status = 'approved',
    approved_by = auth.uid(),
    approved_at = NOW()
  WHERE order_id = p_order_id;
  
  -- Cria or√ßamentos para cada componente
  FOR v_responses IN 
    SELECT DISTINCT dr.component, dr.id AS response_id
    FROM diagnostic_responses dr
    WHERE dr.order_id = p_order_id
  LOOP
    -- Busca servi√ßos sugeridos deste componente
    FOR v_service IN
      SELECT DISTINCT 
        jsonb_array_elements_text(dri.suggested_services) AS service_code
      FROM diagnostic_response_items dri
      WHERE dri.response_id = v_responses.response_id
      AND dri.suggested_services != '[]'::jsonb
    LOOP
      -- Cria or√ßamento (simplificado - melhorar com agrega√ß√£o)
      INSERT INTO detailed_budgets (
        order_id,
        component,
        diagnostic_response_id,
        status,
        services,
        created_by
      ) VALUES (
        p_order_id,
        v_responses.component,
        v_responses.response_id,
        'draft',
        jsonb_build_array(
          jsonb_build_object(
            'service_code', v_service.service_code
          )
        ),
        auth.uid()
      )
      ON CONFLICT (order_id, component) DO UPDATE
      SET services = detailed_budgets.services || EXCLUDED.services;
      
    END LOOP;
  END LOOP;
  
  -- Atualiza workflow da OS
  UPDATE order_workflow
  SET current_stage = 'aguardando_orcamento'
  WHERE order_id = p_order_id;
  
  -- Cria notifica√ß√£o para gerente
  INSERT INTO notifications (user_id, type, title, message, metadata)
  SELECT 
    p.id,
    'diagnostic_approved',
    'Diagn√≥stico Aprovado',
    'OS #' || o.order_number || ' - Diagn√≥stico aprovado. Criar or√ßamento.',
    jsonb_build_object('order_id', p_order_id)
  FROM profiles p
  JOIN orders o ON o.id = p_order_id
  WHERE p.org_id = o.org_id
    AND p.role IN ('gerente', 'admin');
  
  RETURN jsonb_build_object(
    'success', true,
    'message', 'Diagn√≥stico aprovado e or√ßamento criado com sucesso'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## üé® Wireframe

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Diagn√≥stico - OS #1234                              [X]    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Progresso Geral: 7/7 componentes diagnosticados ‚úÖ          ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ ‚úÖ Bloco (4 servi√ßos selecionados)                      ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Cabe√ßote (2 servi√ßos selecionados)                   ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Virabrequim (1 servi√ßo selecionado)                  ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Biela (1 servi√ßo selecionado)                        ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Pist√£o (1 servi√ßo selecionado)                       ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Comando (nenhum servi√ßo necess√°rio)                  ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Eixo (nenhum servi√ßo necess√°rio)                     ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Total de Servi√ßos: 9                                        ‚îÇ
‚îÇ  Valor Estimado: R$ 4.860,00                                 ‚îÇ
‚îÇ  Tempo Estimado: 18.5 horas                                  ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ              [Ver Resumo Completo]                           ‚îÇ
‚îÇ              [‚úÖ Aprovar Diagn√≥stico e Gerar Or√ßamento]      ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ MODAL: Revis√£o Final ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ                                                     [X] ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  üìã REVISAR DIAGN√ìSTICO - OS #1234                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚úÖ Todos os componentes diagnosticados                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚úÖ 89/92 campos preenchidos (97%)                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚úÖ 9 servi√ßos selecionados                            ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  RESUMO POR COMPONENTE:                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Bloco: 4 servi√ßos - R$ 2.550,00                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Cabe√ßote: 2 servi√ßos - R$ 830,00                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Virabrequim: 1 servi√ßo - R$ 950,00                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Biela: 1 servi√ßo - R$ 180,00                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Pist√£o: 1 servi√ßo - R$ 350,00                      ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Comando: Sem necessidade de servi√ßos                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Eixo: Sem necessidade de servi√ßos                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  TOTAL: R$ 4.860,00 | 18.5 horas                      ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚ö†Ô∏è Ao aprovar, um or√ßamento rascunho ser√° criado     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     automaticamente. Voc√™ poder√° edit√°-lo antes       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ     de enviar ao cliente.                              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ           [Cancelar]  [‚úÖ Aprovar e Continuar]         ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß™ Test Scenarios

### E2E Test 1: Aprovar Diagn√≥stico Completo
```gherkin
Given que diagnostiquei todos os 7 componentes
And todos os campos obrigat√≥rios foram preenchidos
And selecionei 9 servi√ßos
When clico em "Aprovar Diagn√≥stico"
Then modal de revis√£o abre
And mostra resumo completo
When confirmo aprova√ß√£o
Then status muda para "approved"
And or√ßamento rascunho √© criado
And workflow muda para "aguardando_orcamento"
And sou redirecionado para /budgets/{order_id}
```

### E2E Test 2: Valida√ß√£o de Pr√©-requisitos
```gherkin
Given que diagnostiquei apenas 5 de 7 componentes
When tento aprovar diagn√≥stico
Then bot√£o "Aprovar" est√° desabilitado
And tooltip mostra: "Complete diagn√≥stico de todos os componentes"
```

### E2E Test 3: Cria√ß√£o Autom√°tica de Or√ßamento
```gherkin
Given que aprovei diagn√≥stico com 9 servi√ßos
When or√ßamento √© criado
Then detailed_budgets tem 7 registros (um por componente)
And servi√ßos est√£o corretamente distribu√≠dos
And subtotais est√£o calculados
And status √© "draft"
```

### E2E Test 4: Notifica√ß√£o ao Gerente
```gherkin
Given que sou t√©cnico
When aprovo diagn√≥stico
Then notifica√ß√£o √© enviada ao gerente
And tipo da notifica√ß√£o √© "diagnostic_approved"
And metadata cont√©m order_id
```

---

## üö´ Negative Scope

**N√£o inclui:**
- Aprova√ß√£o multi-n√≠vel (t√©cnico ‚Üí gerente)
- Rejei√ß√£o de diagn√≥stico com motivo
- Compara√ß√£o com diagn√≥sticos anteriores
- Gera√ß√£o de PDF do diagn√≥stico

---

## üîó Dependencies

**Blocks:**
- US-ORC-001 (Criar Or√ßamento Detalhado)

**Blocked by:**
- US-DIAG-001 (Criar Checklist)
- US-DIAG-002 (Responder Diagn√≥stico)
- US-DIAG-003 (Upload de Fotos)
- US-DIAG-004 (Sugest√£o de Servi√ßos)

---

**√öltima atualiza√ß√£o:** 2025-01-27  
**Vers√£o:** 1.0
