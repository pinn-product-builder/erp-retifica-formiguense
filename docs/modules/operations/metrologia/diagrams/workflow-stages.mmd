%% Diagrama: Workflow de Metrologia - 5 Etapas
%% DescriÃ§Ã£o: VisualizaÃ§Ã£o do fluxo completo das 5 etapas da metrologia

graph TB
    Start[ğŸ¬ InÃ­cio: OS no Stage 8] --> Check{InspeÃ§Ã£o<br/>existe?}
    Check -->|NÃ£o| Create[Criar InspeÃ§Ã£o<br/>Status: em_andamento<br/>Gerar nÃºmero MET-YYYY-XXXX]
    Check -->|Sim| Resume[Continuar InspeÃ§Ã£o<br/>na etapa atual]
    
    Create --> Step1
    Resume --> CurrentStep{Qual<br/>etapa?}
    CurrentStep -->|1| Step1
    CurrentStep -->|2| Step2
    CurrentStep -->|3| Step3
    CurrentStep -->|4| Step4
    CurrentStep -->|5| Step5
    
    Step1[ğŸ“ ETAPA 1<br/>IdentificaÃ§Ã£o do Motor<br/>â”â”â”â”â”â”â”â”â”â”<br/>âœ“ Tipo de motor<br/>âœ“ Marca/Modelo/Ano<br/>âœ“ NÃºmero do motor<br/>âœ“ Data e hora de entrada<br/>âœ“ Fotos do motor<br/>â”â”â”â”â”â”â”â”â”â”<br/>Progresso: 20%] --> Valid1{ValidaÃ§Ã£o<br/>OK?}
    
    Valid1 -->|NÃ£o| Error1[âŒ Campos obrigatÃ³rios<br/>nÃ£o preenchidos]
    Error1 --> Step1
    Valid1 -->|Sim| Save1[ğŸ’¾ Salvar em<br/>motor_identification JSONB<br/>UPDATE current_step = 2]
    Save1 --> Step2
    
    Step2[ğŸ“¦ ETAPA 2<br/>Componentes Recebidos<br/>â”â”â”â”â”â”â”â”â”â”<br/>â˜‘ï¸ Bloco do motor<br/>â˜‘ï¸ Virabrequim<br/>â˜‘ï¸ Bielas<br/>â˜‘ï¸ CabeÃ§ote<br/>â˜‘ï¸ Comando<br/>â˜ Outros<br/>â”â”â”â”â”â”â”â”â”â”<br/>Progresso: 40%] --> Valid2{Ao menos<br/>1 componente?}
    
    Valid2 -->|NÃ£o| Error2[âŒ Selecione pelo menos<br/>1 componente]
    Error2 --> Step2
    Valid2 -->|Sim| Save2[ğŸ’¾ Salvar em<br/>components_received JSONB<br/>UPDATE current_step = 3]
    Save2 --> Step3
    
    Step3[ğŸ” ETAPA 3<br/>AnÃ¡lise Visual<br/>â”â”â”â”â”â”â”â”â”â”<br/>Para cada componente:<br/>âœ“ Checklist visual<br/>  â€¢ Trincas<br/>  â€¢ Desgaste<br/>  â€¢ OxidaÃ§Ã£o<br/>âœ“ ObservaÃ§Ãµes<br/>âœ“ Fotos detalhadas<br/>â”â”â”â”â”â”â”â”â”â”<br/>Progresso: 60%] --> Valid3{Todos componentes<br/>analisados?}
    
    Valid3 -->|NÃ£o| Error3[âŒ Complete anÃ¡lise de<br/>todos os componentes]
    Error3 --> Step3
    Valid3 -->|Sim| Save3[ğŸ’¾ INSERT INTO motor_dna<br/>1 registro por componente<br/>UPDATE current_step = 4<br/>SET visual_analysis_completed = true]
    Save3 --> Step4
    
    Step4[ğŸ“ ETAPA 4<br/>MediÃ§Ãµes Dimensionais<br/>â”â”â”â”â”â”â”â”â”â”<br/>Para cada ponto:<br/>âœ“ Valor nominal<br/>âœ“ TolerÃ¢ncias min/max<br/>âœ“ Valor medido<br/>âœ“ Status calculado<br/>  ğŸŸ¢ OK<br/>  ğŸŸ¡ AtenÃ§Ã£o<br/>  ğŸ”´ Fora<br/>â”â”â”â”â”â”â”â”â”â”<br/>Progresso: 80%] --> Valid4{MediÃ§Ãµes<br/>registradas?}
    
    Valid4 -->|NÃ£o| Error4[âŒ Registre as mediÃ§Ãµes<br/>dimensionais]
    Error4 --> Step4
    Valid4 -->|Sim| Save4[ğŸ’¾ INSERT INTO<br/>dimensional_measurements<br/>1 registro por mediÃ§Ã£o<br/>UPDATE current_step = 5<br/>SET measurements_completed = true]
    Save4 --> Step5
    
    Step5[ğŸ“„ ETAPA 5<br/>Parecer TÃ©cnico<br/>â”â”â”â”â”â”â”â”â”â”<br/>âœ“ DiagnÃ³stico auto-gerado<br/>âœ“ Causas provÃ¡veis<br/>âœ“ RecomendaÃ§Ãµes<br/>âœ“ ServiÃ§os sugeridos<br/>â”â”â”â”â”â”â”â”â”â”<br/>Progresso: 100%] --> EditReport[âœï¸ Revisar e editar<br/>diagnÃ³stico]
    
    EditReport --> GeneratePDF[ğŸ”„ Gerar PDF<br/>Edge Function]
    GeneratePDF --> PDFCreated[ğŸ“„ PDF Gerado<br/>â”â”â”â”â”â”â”â”â”â”<br/>INSERT INTO technical_reports<br/>Upload para Storage<br/>UPDATE inspection_status = 'concluido']
    
    PDFCreated --> Choice{PrÃ³xima<br/>aÃ§Ã£o?}
    
    Choice -->|Download| Download[ğŸ“¥ Baixar PDF]
    Choice -->|Ver DNA| DNA[ğŸ§¬ Visualizar DNA do Motor<br/>HistÃ³rico completo]
    Choice -->|Criar OrÃ§amento| Budget[ğŸ’° TransiÃ§Ã£o para OrÃ§amento<br/>â”â”â”â”â”â”â”â”â”â”<br/>1. Criar budget<br/>2. PrÃ©-preencher serviÃ§os<br/>3. Anexar PDF<br/>4. UPDATE orders<br/>   SET current_stage = 'budgeting'<br/>5. UPDATE inspection_status = 'approved']
    
    Download --> End1[âœ… ConcluÃ­do]
    DNA --> End2[âœ… ConcluÃ­do]
    Budget --> End3[âœ… OrÃ§amento Criado<br/>Stage 9: Budgeting]
    
    %% Estilos
    classDef startStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000
    classDef stepStyle fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#000
    classDef errorStyle fill:#ffcdd2,stroke:#f44336,stroke-width:2px,color:#000
    classDef successStyle fill:#c8e6c9,stroke:#4caf50,stroke-width:2px,color:#000
    classDef decisionStyle fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px,color:#000
    
    class Start,Create startStyle
    class Step1,Step2,Step3,Step4,Step5 stepStyle
    class Error1,Error2,Error3,Error4 errorStyle
    class PDFCreated,End1,End2,End3 successStyle
    class Check,CurrentStep,Valid1,Valid2,Valid3,Valid4,Choice decisionStyle
