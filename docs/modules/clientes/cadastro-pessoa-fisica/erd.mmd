```mermaid
erDiagram
    ORGANIZATIONS ||--o{ CUSTOMERS : "tem"
    CUSTOMERS ||--o{ ORDERS : "faz"
    CUSTOMERS ||--o{ BUDGETS : "recebe"
    CUSTOMERS ||--o{ COLLECTIONS : "solicita"
    AUTH_USERS ||--o{ CUSTOMERS : "cria"
    
    ORGANIZATIONS {
        uuid id PK
        string name
        string cnpj
        boolean active
        timestamptz created_at
    }
    
    CUSTOMERS {
        uuid id PK
        uuid org_id FK
        string type "direto|oficina"
        string cpf UK "11 d√≠gitos"
        string name "NOT NULL"
        string phone "NOT NULL"
        string email "opcional"
        string address_cep
        string address_street
        string address_number
        string address_complement
        string address_neighborhood
        string address_city
        string address_state
        string cnpj UK "14 d√≠gitos (PJ)"
        string company_name "PJ"
        string trade_name "PJ"
        string contact_person "PJ"
        text notes
        boolean active "default true"
        timestamptz created_at
        timestamptz updated_at
        uuid created_by FK
    }
    
    AUTH_USERS {
        uuid id PK
        string email UK
        timestamptz created_at
    }
    
    ORDERS {
        uuid id PK
        uuid org_id FK
        uuid customer_id FK
        string order_number UK
        string status
        timestamptz created_at
    }
    
    BUDGETS {
        uuid id PK
        uuid org_id FK
        uuid customer_id FK
        string budget_number UK
        string status
        decimal total_amount
        timestamptz created_at
    }
    
    COLLECTIONS {
        uuid id PK
        uuid org_id FK
        uuid customer_id FK
        string collection_number UK
        date collection_date
        time collection_time
        string location
        timestamptz created_at
    }
```

## üìä Relacionamentos

### 1:N - Organizations ‚Üí Customers
- Uma organiza√ß√£o tem m√∫ltiplos clientes
- Um cliente pertence a uma organiza√ß√£o
- Constraint: `org_id` NOT NULL, FK com CASCADE DELETE

### 1:N - Customers ‚Üí Orders
- Um cliente pode ter m√∫ltiplos pedidos/OS
- Um pedido pertence a um cliente
- Constraint: `customer_id` NOT NULL

### 1:N - Customers ‚Üí Budgets
- Um cliente pode receber m√∫ltiplos or√ßamentos
- Um or√ßamento √© para um cliente
- Constraint: `customer_id` NOT NULL

### 1:N - Customers ‚Üí Collections
- Um cliente pode solicitar m√∫ltiplas coletas
- Uma coleta √© para um cliente
- Constraint: `customer_id` NOT NULL

### 1:N - Auth Users ‚Üí Customers
- Um usu√°rio pode criar m√∫ltiplos clientes
- Um cliente √© criado por um usu√°rio
- Constraint: `created_by` NULL (opcional)

## üîë Constraints Principais

### Unicidade
- `UNIQUE (org_id, cpf)` - CPF √∫nico por organiza√ß√£o
- `UNIQUE (org_id, cnpj)` - CNPJ √∫nico por organiza√ß√£o

### Check Constraints
- `type IN ('direto', 'oficina')` - Apenas tipos v√°lidos
- `length(cpf) = 11` - CPF sempre 11 d√≠gitos
- `length(cnpj) = 14` - CNPJ sempre 14 d√≠gitos
- `(type = 'direto' AND cpf IS NOT NULL)` - PF deve ter CPF
- `(type = 'oficina' AND cnpj IS NOT NULL)` - PJ deve ter CNPJ

### Foreign Keys
- `org_id ‚Üí organizations(id)` ON DELETE CASCADE
- `created_by ‚Üí auth.users(id)` ON DELETE SET NULL

## üìà √çndices

### Performance
- `idx_customers_cpf` - Busca r√°pida por CPF
- `idx_customers_cnpj` - Busca r√°pida por CNPJ
- `idx_customers_name` - Busca full-text por nome (GIN)
- `idx_customers_phone` - Busca por telefone
- `idx_customers_active` - Filtro de ativos

## üîí Row Level Security (RLS)

### SELECT Policy
```sql
-- Usu√°rios veem clientes da sua organiza√ß√£o
org_id IN (SELECT org_id FROM profiles WHERE id = auth.uid())
```

### INSERT Policy
```sql
-- Usu√°rios criam clientes na sua organiza√ß√£o
org_id IN (SELECT org_id FROM profiles WHERE id = auth.uid())
```

### UPDATE Policy
```sql
-- Usu√°rios editam clientes da sua organiza√ß√£o
org_id IN (SELECT org_id FROM profiles WHERE id = auth.uid())
```

### DELETE Policy
```sql
-- Apenas admin pode deletar
org_id IN (SELECT org_id FROM profiles WHERE id = auth.uid() AND role = 'admin')
```
