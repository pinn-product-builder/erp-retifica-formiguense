# US-ORC-005: Registrar Aprova√ß√£o/Rejei√ß√£o do Cliente

**ID:** US-ORC-005  
**Epic:** Or√ßamentos  
**Sprint:** 5  
**Prioridade:** Cr√≠tica  
**Estimativa:** 8 pontos  
**Status:** Backlog  

---

## üìã User Story

**Como** gerente comercial  
**Quero** registrar a decis√£o do cliente sobre o or√ßamento  
**Para** documentar aprova√ß√µes e iniciar execu√ß√£o dos servi√ßos

---

## üéØ Business Objective

Criar sistema robusto de aprova√ß√£o com documenta√ß√£o comprobat√≥ria obrigat√≥ria e diferentes modalidades de aprova√ß√£o (total, parcial, rejei√ß√£o).

---

## üìê Business Rules

### RN028: Tipos de Aprova√ß√£o
```typescript
type ApprovalType = 
  | 'total'              // Cliente aprovou tudo
  | 'partial'            // Cliente aprovou apenas alguns itens
  | 'rejected';          // Cliente rejeitou o or√ßamento

interface BudgetApproval {
  id: string;
  budget_id: string;
  approval_type: ApprovalType;
  approval_method: ApprovalMethod;
  approved_by_customer: string;    // Nome do aprovador
  approved_at: Date;
  
  // Aprova√ß√£o parcial
  approved_services?: string[];    // IDs dos servi√ßos aprovados
  approved_parts?: string[];       // IDs das pe√ßas aprovadas
  approved_amount?: number;        // Valor total aprovado
  
  // Documenta√ß√£o OBRIGAT√ìRIA
  approval_document: {
    file_url: string;              // URL do Supabase Storage
    file_name: string;
    file_type: 'image/jpeg' | 'image/jpg' | 'image/png';
    uploaded_at: Date;
  };
  
  approval_notes?: string;
  registered_by: string;           // Usu√°rio que registrou
}
```

### RN029: M√©todos de Aprova√ß√£o
```typescript
type ApprovalMethod = 
  | 'signature'      // Assinatura f√≠sica digitalizada
  | 'whatsapp'       // Print de conversa WhatsApp
  | 'email'          // Screenshot de email
  | 'verbal';        // Confirma√ß√£o verbal (foto/print registro)

// TODOS os m√©todos exigem upload de imagem obrigat√≥ria
const documentRequirements = {
  signature: 'Foto da assinatura f√≠sica no or√ßamento impresso',
  whatsapp: 'Print da conversa confirmando aprova√ß√£o',
  email: 'Screenshot do email de confirma√ß√£o',
  verbal: 'Foto ou print do registro de confirma√ß√£o verbal'
};
```

### RN030: Valida√ß√£o de Documento
**Requisitos obrigat√≥rios:**
- ‚úÖ Arquivo de imagem (JPEG, JPG ou PNG apenas)
- ‚úÖ Tamanho m√°ximo: 5 MB
- ‚úÖ Upload bem-sucedido no Supabase Storage
- ‚úÖ Nome descritivo do arquivo
- ‚õî N√£o aceita: PDF, DOC, TXT ou outros formatos

### RN031: Aprova√ß√£o Total
**Quando cliente aprova tudo:**
1. Status do or√ßamento ‚Üí `customer_approved`
2. Todos os servi√ßos/pe√ßas marcados como aprovados
3. Valor aprovado = valor total do or√ßamento
4. Documento comprobat√≥rio √© armazenado
5. Notifica√ß√£o enviada ao gerente
6. Or√ßamento aguarda aprova√ß√£o interna final

### RN032: Aprova√ß√£o Parcial
**Quando cliente aprova apenas alguns itens:**
1. Status do or√ßamento ‚Üí `partially_approved`
2. Sistema exibe seletor de itens
3. Usu√°rio marca quais servi√ßos/pe√ßas foram aprovados
4. Valor aprovado = soma dos itens selecionados
5. Novo or√ßamento pode ser gerado com itens rejeitados
6. Documento comprova aprova√ß√£o parcial

### RN033: Rejei√ß√£o
**Quando cliente rejeita:**
1. Status do or√ßamento ‚Üí `rejected`
2. Campo de justificativa √© obrigat√≥rio
3. Documento de rejei√ß√£o √© armazenado
4. Or√ßamento pode ser revisado (novo or√ßamento gerado)
5. Notifica√ß√£o com motivo da rejei√ß√£o

### RN034: Portal do Cliente
**Cliente pode aprovar diretamente pelo portal:**
```typescript
// Fluxo no portal p√∫blico
1. Cliente acessa link recebido
2. Visualiza or√ßamento completo
3. Escolhe uma op√ß√£o:
   - "‚úÖ Aprovar Tudo"
   - "üìù Aprovar Parcialmente"
   - "‚ùå Rejeitar"
4. Para qualquer op√ß√£o:
   - Preenche nome completo
   - Pode adicionar observa√ß√µes
   - Upload de documento comprobat√≥rio
5. Submete aprova√ß√£o
6. Recebe confirma√ß√£o por email/WhatsApp
```

### RN035: Hist√≥rico de Aprova√ß√µes
**Auditoria completa:**
- Todas as aprova√ß√µes s√£o registradas
- Hist√≥rico mostra quem aprovou, quando e como
- Documentos ficam arquivados permanentemente
- Imposs√≠vel deletar aprova√ß√µes (apenas visualizar)

---

## ‚úÖ Acceptance Criteria

**AC29:** Bot√£o "Registrar Aprova√ß√£o" aparece para or√ßamentos pendentes  
**AC30:** Modal permite selecionar tipo (Total/Parcial/Rejeitado)  
**AC31:** Upload de imagem comprobat√≥ria √© obrigat√≥rio  
**AC32:** Sistema valida formato de arquivo (JPEG/JPG/PNG)  
**AC33:** Aprova√ß√£o parcial exibe seletor de itens  
**AC34:** Status do or√ßamento √© atualizado automaticamente  
**AC35:** Hist√≥rico completo de aprova√ß√µes √© exibido  
**AC36:** Portal p√∫blico permite cliente aprovar diretamente

---

## üõ†Ô∏è Definition of Done

- [ ] Componente `BudgetApprovalModal.tsx` implementado
- [ ] Componente `ItemSelector.tsx` criado (aprova√ß√£o parcial)
- [ ] Hook `useBudgetApproval.ts` implementado
- [ ] Tabela `budget_approvals` criada
- [ ] Storage bucket `budget-approvals` configurado
- [ ] RLS policies para aprova√ß√µes criadas
- [ ] Portal p√∫blico com formul√°rio de aprova√ß√£o
- [ ] Valida√ß√£o de formatos de arquivo
- [ ] Hist√≥rico de aprova√ß√µes vis√≠vel
- [ ] Notifica√ß√µes implementadas
- [ ] Testes E2E escritos

---

## üìÅ Affected Components

```
src/components/budgets/
  ‚îú‚îÄ‚îÄ BudgetApprovalModal.tsx      (NEW)
  ‚îú‚îÄ‚îÄ ItemSelector.tsx             (NEW)
  ‚îú‚îÄ‚îÄ ApprovalHistory.tsx          (NEW)
  ‚îî‚îÄ‚îÄ ApprovalDocumentUpload.tsx   (NEW)

src/pages/
  ‚îî‚îÄ‚îÄ PublicBudgetView.tsx         (UPDATE - formul√°rio)

src/hooks/
  ‚îî‚îÄ‚îÄ useBudgetApproval.ts         (NEW)
```

---

## üóÑÔ∏è Database Schema

```sql
-- Tabela de aprova√ß√µes
CREATE TABLE budget_approvals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  budget_id UUID REFERENCES detailed_budgets(id) NOT NULL,
  approval_type TEXT NOT NULL CHECK (
    approval_type IN ('total', 'partial', 'rejected')
  ),
  approval_method TEXT NOT NULL CHECK (
    approval_method IN ('signature', 'whatsapp', 'email', 'verbal')
  ),
  
  -- Identifica√ß√£o do aprovador
  approved_by_customer TEXT NOT NULL,
  approved_at TIMESTAMPTZ DEFAULT now(),
  
  -- Aprova√ß√£o parcial
  approved_services JSONB DEFAULT '[]'::jsonb,
  approved_parts JSONB DEFAULT '[]'::jsonb,
  approved_amount NUMERIC(10,2),
  
  -- Documento OBRIGAT√ìRIO
  approval_document JSONB NOT NULL,  -- { file_url, file_name, file_type, uploaded_at }
  
  approval_notes TEXT,
  rejection_reason TEXT,  -- Obrigat√≥rio se rejected
  
  -- Auditoria
  registered_by UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  
  -- Valida√ß√µes
  CONSTRAINT check_rejection_reason 
    CHECK (
      (approval_type = 'rejected' AND rejection_reason IS NOT NULL) OR
      (approval_type != 'rejected')
    ),
  CONSTRAINT check_partial_items
    CHECK (
      (approval_type = 'partial' AND 
       (jsonb_array_length(approved_services) > 0 OR 
        jsonb_array_length(approved_parts) > 0)) OR
      (approval_type != 'partial')
    )
);

-- √çndices
CREATE INDEX idx_budget_approvals_budget ON budget_approvals(budget_id);
CREATE INDEX idx_budget_approvals_type ON budget_approvals(approval_type);

-- RLS
ALTER TABLE budget_approvals ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view approvals of their org budgets"
  ON budget_approvals FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM detailed_budgets db
      JOIN orders o ON o.id = db.order_id
      WHERE db.id = budget_approvals.budget_id
      AND o.org_id = (SELECT org_id FROM profiles WHERE id = auth.uid())
    )
  );

CREATE POLICY "Users can create approvals"
  ON budget_approvals FOR INSERT
  WITH CHECK (
    registered_by = auth.uid()
    AND EXISTS (
      SELECT 1 FROM detailed_budgets db
      JOIN orders o ON o.id = db.order_id
      WHERE db.id = budget_approvals.budget_id
      AND o.org_id = (SELECT org_id FROM profiles WHERE id = auth.uid())
    )
  );

-- N√£o permite UPDATE ou DELETE em aprova√ß√µes (auditoria)
-- Aprova√ß√µes s√£o imut√°veis ap√≥s cria√ß√£o

-- Fun√ß√£o para processar aprova√ß√£o
CREATE OR REPLACE FUNCTION process_budget_approval(
  p_budget_id UUID,
  p_approval_type TEXT,
  p_approval_method TEXT,
  p_approved_by_customer TEXT,
  p_approval_document JSONB,
  p_approved_services JSONB DEFAULT '[]'::jsonb,
  p_approved_parts JSONB DEFAULT '[]'::jsonb,
  p_approval_notes TEXT DEFAULT NULL,
  p_rejection_reason TEXT DEFAULT NULL
) RETURNS JSONB AS $$
DECLARE
  v_new_status TEXT;
  v_approved_amount NUMERIC(10,2);
  v_approval_id UUID;
BEGIN
  -- Determinar novo status
  CASE p_approval_type
    WHEN 'total' THEN v_new_status := 'customer_approved';
    WHEN 'partial' THEN v_new_status := 'partially_approved';
    WHEN 'rejected' THEN v_new_status := 'rejected';
  END CASE;
  
  -- Calcular valor aprovado
  IF p_approval_type = 'total' THEN
    SELECT total INTO v_approved_amount 
    FROM detailed_budgets WHERE id = p_budget_id;
  ELSIF p_approval_type = 'partial' THEN
    -- Calcular com base nos itens selecionados
    SELECT 
      COALESCE(SUM((item->>'total_price')::NUMERIC), 0)
    INTO v_approved_amount
    FROM detailed_budgets db
    CROSS JOIN jsonb_array_elements(db.services) AS item
    WHERE db.id = p_budget_id
    AND item->>'service_code' = ANY(
      SELECT jsonb_array_elements_text(p_approved_services)
    );
    
    -- Adicionar pe√ßas aprovadas
    v_approved_amount := v_approved_amount + (
      SELECT COALESCE(SUM((item->>'total_price')::NUMERIC), 0)
      FROM detailed_budgets db
      CROSS JOIN jsonb_array_elements(db.parts) AS item
      WHERE db.id = p_budget_id
      AND item->>'part_id' = ANY(
        SELECT jsonb_array_elements_text(p_approved_parts)
      )
    );
  ELSE
    v_approved_amount := 0;
  END IF;
  
  -- Inserir aprova√ß√£o
  INSERT INTO budget_approvals (
    budget_id, approval_type, approval_method,
    approved_by_customer, approval_document,
    approved_services, approved_parts, approved_amount,
    approval_notes, rejection_reason,
    registered_by
  ) VALUES (
    p_budget_id, p_approval_type, p_approval_method,
    p_approved_by_customer, p_approval_document,
    p_approved_services, p_approved_parts, v_approved_amount,
    p_approval_notes, p_rejection_reason,
    COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid)
  ) RETURNING id INTO v_approval_id;
  
  -- Atualizar status do or√ßamento
  UPDATE detailed_budgets
  SET status = v_new_status,
      updated_at = now()
  WHERE id = p_budget_id;
  
  RETURN jsonb_build_object(
    'approval_id', v_approval_id,
    'new_status', v_new_status,
    'approved_amount', v_approved_amount
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Storage bucket para documentos de aprova√ß√£o
INSERT INTO storage.buckets (id, name, public)
VALUES ('budget-approvals', 'budget-approvals', false)
ON CONFLICT (id) DO NOTHING;

-- Pol√≠ticas de storage
CREATE POLICY "Users can upload approval documents"
  ON storage.objects FOR INSERT
  WITH CHECK (
    bucket_id = 'budget-approvals'
    AND (storage.foldername(name))[1] = auth.uid()::text
  );

CREATE POLICY "Users can view approval documents of their org"
  ON storage.objects FOR SELECT
  USING (
    bucket_id = 'budget-approvals'
    AND EXISTS (
      SELECT 1 FROM budget_approvals ba
      JOIN detailed_budgets db ON db.id = ba.budget_id
      JOIN orders o ON o.id = db.order_id
      WHERE ba.approval_document->>'file_url' LIKE '%' || (storage.objects.name) || '%'
      AND o.org_id = (SELECT org_id FROM profiles WHERE id = auth.uid())
    )
  );
```

---

## üé® Wireframe

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Registrar Aprova√ß√£o - ORC-2025-0004-BIELA              [X]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  Cliente: ABC Motors Ltda                                    ‚îÇ
‚îÇ  Contato: Jo√£o Silva                                         ‚îÇ
‚îÇ  Enviado em: 27/01/2025 √†s 14:35                            ‚îÇ
‚îÇ  Status: Aguardando aprova√ß√£o                                ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ TIPO DE APROVA√á√ÉO *                                      ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ (‚Ä¢) Aprova√ß√£o Total                                      ‚îÇ‚îÇ
‚îÇ  ‚îÇ     Cliente aprovou todo o or√ßamento (R$ 932,40)        ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ [ ] Aprova√ß√£o Parcial                                    ‚îÇ‚îÇ
‚îÇ  ‚îÇ     Cliente aprovou apenas alguns itens                  ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ [ ] Rejeitado                                            ‚îÇ‚îÇ
‚îÇ  ‚îÇ     Cliente recusou o or√ßamento                          ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ M√âTODO DE APROVA√á√ÉO *                                    ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ [‚ñº WhatsApp                                  ]           ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ Op√ß√µes:                                                  ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ WhatsApp - Print da conversa                           ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Email - Screenshot da confirma√ß√£o                      ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Assinatura f√≠sica - Foto digitalizada                  ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Confirma√ß√£o verbal - Foto/print do registro            ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Nome do Aprovador (Cliente): *                              ‚îÇ
‚îÇ  [Jo√£o Silva_____________________________]                   ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ DOCUMENTO COMPROBAT√ìRIO (OBRIGAT√ìRIO) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ üì§ Arraste uma imagem ou clique para selecionar         ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ Formatos aceitos: JPEG, JPG, PNG                         ‚îÇ‚îÇ
‚îÇ  ‚îÇ Tamanho m√°ximo: 5 MB                                     ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚ÑπÔ∏è Para WhatsApp: Tire um print da conversa confirmando‚îÇ‚îÇ
‚îÇ  ‚îÇ    a aprova√ß√£o do or√ßamento                              ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Observa√ß√µes (opcional):                                     ‚îÇ
‚îÇ  [____________________________________________________________]‚îÇ
‚îÇ  [Cliente aprovou via WhatsApp √†s 15:20.                    ]‚îÇ
‚îÇ  [Solicitou in√≠cio imediato dos servi√ßos                    ]‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ                      [Cancelar]  [‚úÖ Registrar Aprova√ß√£o]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ APROVA√á√ÉO PARCIAL (quando selecionado) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                               ‚îÇ
‚îÇ  SELECIONE OS ITENS APROVADOS                                ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  SERVI√áOS (1 item):                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ [‚úì] SRV-001 - Ret√≠fica de bielas          R$ 450,00     ‚îÇ‚îÇ
‚îÇ  ‚îÇ     4 horas estimadas                                    ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  PE√áAS (2 itens):                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ [‚úì] PCA-1523 - Jogo de bronzinas 0.50mm   R$ 380,00    ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ [ ] PCA-2801 - Parafusos de biela         R$  95,00    ‚îÇ‚îÇ
‚îÇ  ‚îÇ     ‚ö†Ô∏è Cliente optou por fornecer pr√≥prio parafuso      ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  RESUMO DA APROVA√á√ÉO:                                        ‚îÇ
‚îÇ  ‚Ä¢ Itens aprovados: 2 de 3                                   ‚îÇ
‚îÇ  ‚Ä¢ Valor aprovado: R$ 830,00                                 ‚îÇ
‚îÇ  ‚Ä¢ Valor n√£o aprovado: R$ 95,00                              ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  üí° Voc√™ pode criar novo or√ßamento com os itens n√£o aprovados‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ HIST√ìRICO DE APROVA√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                               ‚îÇ
‚îÇ  ORC-2025-0004-BIELA                                         ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚úÖ APROVA√á√ÉO REGISTRADA                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ Tipo: Aprova√ß√£o Total                                    ‚îÇ‚îÇ
‚îÇ  ‚îÇ M√©todo: WhatsApp                                         ‚îÇ‚îÇ
‚îÇ  ‚îÇ Aprovado por: Jo√£o Silva (Cliente)                       ‚îÇ‚îÇ
‚îÇ  ‚îÇ Data/Hora: 27/01/2025 √†s 15:22                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ Valor aprovado: R$ 932,40                                ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ Observa√ß√µes:                                             ‚îÇ‚îÇ
‚îÇ  ‚îÇ Cliente aprovou via WhatsApp √†s 15:20.                   ‚îÇ‚îÇ
‚îÇ  ‚îÇ Solicitou in√≠cio imediato dos servi√ßos                   ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ Documento:                                               ‚îÇ‚îÇ
‚îÇ  ‚îÇ [üìÑ whatsapp-aprovacao-27012025.jpg]  [üëÅÔ∏è Visualizar]  ‚îÇ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ Registrado por: Carlos Mendes (Gerente)                  ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Status atual: Aprovado pelo cliente                         ‚îÇ
‚îÇ  Pr√≥ximo passo: Aprova√ß√£o interna e gera√ß√£o de conta a receber‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß™ Test Scenarios

### E2E Test 1: Aprova√ß√£o Total Completa
```gherkin
Given que tenho or√ßamento com status "pending_customer"
When abro modal de aprova√ß√£o
And seleciono "Aprova√ß√£o Total"
And seleciono m√©todo "WhatsApp"
And preencho nome "Jo√£o Silva"
And fa√ßo upload de imagem v√°lida
And clico em "Registrar Aprova√ß√£o"
Then aprova√ß√£o √© salva com sucesso
And status muda para "customer_approved"
And documento √© armazenado no storage
And hist√≥rico exibe a aprova√ß√£o
```

### E2E Test 2: Valida√ß√£o de Upload Obrigat√≥rio
```gherkin
Given que preenchi todos os campos
When n√£o fa√ßo upload de documento
And clico em "Registrar Aprova√ß√£o"
Then erro de valida√ß√£o aparece
And mensagem: "Documento comprobat√≥rio √© obrigat√≥rio"
And formul√°rio n√£o √© submetido
```

### E2E Test 3: Valida√ß√£o de Formato de Arquivo
```gherkin
Given que tento fazer upload de PDF
When seleciono arquivo "orcamento.pdf"
Then erro aparece
And mensagem: "Apenas imagens JPEG/JPG/PNG s√£o aceitas"
And upload √© recusado
```

### E2E Test 4: Aprova√ß√£o Parcial com Sele√ß√£o
```gherkin
Given que seleciono "Aprova√ß√£o Parcial"
When modal de sele√ß√£o de itens aparece
And marco 2 de 3 itens
Then valor aprovado √© calculado: R$ 830,00
And resumo mostra "2 de 3 itens aprovados"
When registro aprova√ß√£o
Then sistema salva itens selecionados
And valor parcial √© gravado
```

### E2E Test 5: Rejei√ß√£o com Justificativa
```gherkin
Given que seleciono "Rejeitado"
When campo "Motivo da rejei√ß√£o" aparece
And n√£o preencho motivo
And tento registrar
Then erro de valida√ß√£o: "Motivo √© obrigat√≥rio para rejei√ß√µes"
When preencho motivo "Valor acima do or√ßado"
And fa√ßo upload de documento
And registro
Then status muda para "rejected"
And motivo √© salvo
```

### E2E Test 6: Cliente Aprova via Portal P√∫blico
```gherkin
Given que cliente acessa link p√∫blico do or√ßamento
When clica em "‚úÖ Aprovar Tudo"
And preenche seu nome
And faz upload de documento
And submete formul√°rio
Then aprova√ß√£o √© registrada automaticamente
And gerente recebe notifica√ß√£o
And status √© atualizado
```

### E2E Test 7: Hist√≥rico de Aprova√ß√µes
```gherkin
Given que or√ßamento possui aprova√ß√£o registrada
When visualizo detalhes do or√ßamento
Then se√ß√£o "Hist√≥rico de Aprova√ß√µes" aparece
And mostra todos os dados da aprova√ß√£o
And bot√£o "Visualizar" abre documento em nova aba
And n√£o permite edi√ß√£o ou exclus√£o
```

---

## üö´ Negative Scope

**N√£o inclui:**
- Assinatura digital eletr√¥nica integrada
- OCR autom√°tico de documentos
- Aprova√ß√£o por m√∫ltiplos stakeholders
- Fluxo de aprova√ß√£o em etapas
- Integra√ß√£o com DocuSign/similar

---

## üîó Dependencies

**Blocks:**
- US-ORC-006 (Gerar Conta a Receber)

**Blocked by:**
- US-ORC-004 (Enviar para Aprova√ß√£o)

**Related:**
- US-EST-007 (Reserva de Estoque ap√≥s Aprova√ß√£o)

---

**√öltima atualiza√ß√£o:** 2025-01-27  
**Vers√£o:** 1.0
