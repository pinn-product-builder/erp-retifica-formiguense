# üì¶ M√≥dulo de Estoque - Regras de Neg√≥cio

## üéØ Vis√£o Geral

O M√≥dulo de Estoque gerencia todo o invent√°rio de pe√ßas e materiais, controlando entradas, sa√≠das, reservas, alertas de estoque baixo, contagens f√≠sicas e rastreabilidade completa.

---

## üè∑Ô∏è Cadastro de Pe√ßas

```mermaid
graph TD
    A[Nova Pe√ßa] --> B[Informa√ß√µes B√°sicas]
    B --> C[Dados T√©cnicos]
    C --> D[Dados Financeiros]
    D --> E[Estoque]
    E --> F[Fornecedores]
    F --> G[Pe√ßa Cadastrada]
    
    G --> H{Tipo de Controle}
    H -->|Lote| I[Rastreabilidade por Lote]
    H -->|N√∫mero de S√©rie| J[Rastreabilidade Individual]
    H -->|Simples| K[Apenas Quantidade]
```

### Estrutura de Dados

```typescript
interface InventoryPart {
  // Identifica√ß√£o
  id: string;
  org_id: string;
  code: string; // C√≥digo interno (ex: "PST-001-STD")
  sku: string; // C√≥digo alternativo
  barcode?: string; // C√≥digo de barras
  
  // Descri√ß√£o
  name: string; // "Pist√£o STD Completo"
  description: string;
  manufacturer: string; // "Mahle"
  manufacturer_code?: string; // C√≥digo do fabricante
  
  // Classifica√ß√£o
  category: 'pistoes' | 'aneis' | 'bronzinas' | 'juntas' | 'retentores' 
    | 'valvulas' | 'guias' | 'molas' | 'correntes' | 'correias' | 'bombas' 
    | 'outros';
  subcategory?: string;
  
  // Aplica√ß√£o
  applications: string[]; // ["Motor Diesel", "4 cilindros"]
  compatible_engines: string[]; // IDs de tipos de motor
  
  // Dados T√©cnicos
  technical_specs: {
    diameter?: number; // mm
    length?: number; // mm
    weight?: number; // kg
    material?: string;
    finish?: string;
    other_specs?: Record<string, any>;
  };
  
  // Estoque
  unit_type: 'piece' | 'kit' | 'meter' | 'liter' | 'kg';
  current_quantity: number;
  minimum_stock: number; // Alerta de estoque baixo
  maximum_stock?: number;
  optimal_stock?: number; // Quantidade ideal
  
  // Localiza√ß√£o F√≠sica
  warehouse_location?: string; // "Prateleira A1"
  storage_zone?: string; // "Zona de Pist√µes"
  
  // Controle
  tracking_type: 'simple' | 'lot' | 'serial_number';
  lot_control: boolean;
  expiry_control: boolean; // Para itens perec√≠veis
  
  // Financeiro
  unit_cost: number; // Custo m√©dio
  selling_price: number;
  margin_percentage: number;
  last_purchase_price?: number;
  last_purchase_date?: Date;
  
  // Fornecedores
  preferred_supplier_id?: string;
  suppliers: Array<{
    supplier_id: string;
    supplier_code: string;
    lead_time_days: number;
    minimum_order_quantity: number;
    last_price: number;
    is_active: boolean;
  }>;
  
  // Flags
  is_active: boolean;
  is_reserved: boolean;
  requires_inspection: boolean; // Inspe√ß√£o ao receber
  
  // Metadados
  photo_url?: string;
  notes?: string;
  created_at: Date;
  updated_at: Date;
}
```

---

## üì• Movimenta√ß√µes de Estoque

```mermaid
graph LR
    A[Movimenta√ß√£o] --> B{Tipo}
    
    B --> C[Entrada]
    B --> D[Sa√≠da]
    B --> E[Ajuste]
    B --> F[Transfer√™ncia]
    B --> G[Devolu√ß√£o]
    
    C --> C1[Compra]
    C --> C2[Devolu√ß√£o Cliente]
    C --> C3[Ajuste Positivo]
    
    D --> D1[Venda/Uso]
    D --> D2[Perda/Quebra]
    D --> D3[Ajuste Negativo]
    
    E --> E1[Invent√°rio]
    E --> E2[Corre√ß√£o]
    
    F --> F1[Entre Locais]
    
    style C fill:#c8e6c9
    style D fill:#ffcdd2
    style E fill:#fff9c4
```

### Tipos de Movimenta√ß√£o

#### 1. Entrada por Compra
```typescript
async function receivePartFromPurchase(poId, receivingData) {
  const po = await getPurchaseOrder(poId);
  
  for (const item of receivingData.items) {
    // Criar movimenta√ß√£o
    await createInventoryMovement({
      org_id: po.org_id,
      part_id: item.part_id,
      movement_type: 'in',
      reason: 'purchase',
      quantity: item.quantity_received,
      unit_cost: item.unit_price,
      total_cost: item.quantity_received * item.unit_price,
      reference_type: 'purchase_order',
      reference_id: poId,
      supplier_id: po.supplier_id,
      invoice_number: receivingData.invoice_number,
      lot_number: item.lot_number, // Se controle de lote
      expiry_date: item.expiry_date, // Se aplic√°vel
      warehouse_location: item.location,
      notes: receivingData.notes,
      created_by: receivingData.received_by
    });
    
    // Atualizar quantidade em estoque
    await updatePartQuantity({
      part_id: item.part_id,
      delta: item.quantity_received,
      new_cost: recalculateAverageCost(item.part_id, item.unit_price, item.quantity_received)
    });
    
    // Se tinha reserva pendente, marcar como dispon√≠vel
    await checkPendingReservations(item.part_id);
  }
}
```

#### 2. Sa√≠da por Uso em OS
```typescript
async function consumePartInOrder(orderId, consumptionData) {
  const order = await getOrder(orderId);
  
  for (const item of consumptionData.items) {
    // Verificar se tem reserva
    const reservation = await getReservation({
      part_id: item.part_id,
      reference_id: order.budget_id
    });
    
    if (reservation) {
      // Liberar reserva
      await releaseReservation(reservation.id, item.quantity);
    }
    
    // Criar movimenta√ß√£o de sa√≠da
    await createInventoryMovement({
      org_id: order.org_id,
      part_id: item.part_id,
      movement_type: 'out',
      reason: 'production_use',
      quantity: item.quantity,
      unit_cost: await getCurrentAverageCost(item.part_id),
      reference_type: 'order',
      reference_id: orderId,
      consumed_by: consumptionData.technician_id,
      notes: `Usado em OS ${order.number}`,
      created_by: consumptionData.registered_by
    });
    
    // Atualizar estoque
    await updatePartQuantity({
      part_id: item.part_id,
      delta: -item.quantity
    });
    
    // Verificar estoque m√≠nimo
    await checkMinimumStock(item.part_id);
  }
}
```

#### 3. Ajuste Manual
```typescript
async function adjustInventory(adjustmentData) {
  // Para corre√ß√µes, perdas, quebras, etc.
  await createInventoryMovement({
    org_id: adjustmentData.org_id,
    part_id: adjustmentData.part_id,
    movement_type: adjustmentData.delta > 0 ? 'in' : 'out',
    reason: 'adjustment',
    quantity: Math.abs(adjustmentData.delta),
    adjustment_reason: adjustmentData.reason, // 'loss', 'damage', 'found', 'correction'
    unit_cost: await getCurrentAverageCost(adjustmentData.part_id),
    notes: adjustmentData.notes,
    requires_approval: Math.abs(adjustmentData.delta * unit_cost) > 500, // > R$ 500 precisa aprova√ß√£o
    created_by: adjustmentData.user_id
  });
  
  // Se precisa aprova√ß√£o, aguardar
  if (!requires_approval) {
    await updatePartQuantity({
      part_id: adjustmentData.part_id,
      delta: adjustmentData.delta
    });
  }
}
```

#### 4. Transfer√™ncia entre Locais
```typescript
async function transferPartLocation(transferData) {
  await createInventoryMovement({
    org_id: transferData.org_id,
    part_id: transferData.part_id,
    movement_type: 'transfer',
    reason: 'location_transfer',
    quantity: transferData.quantity,
    from_location: transferData.from_location,
    to_location: transferData.to_location,
    notes: transferData.notes,
    created_by: transferData.user_id
  });
  
  // Atualizar localiza√ß√£o da pe√ßa
  await updatePartLocation(transferData.part_id, transferData.to_location);
}
```

---

## üîí Sistema de Reservas

```mermaid
sequenceDiagram
    participant B as Or√ßamento
    participant I as Estoque
    participant R as Reservas
    participant P as Compras
    
    B->>I: Or√ßamento aprovado - Reservar pe√ßas
    I->>I: Verificar disponibilidade
    
    alt Pe√ßa em estoque
        I->>R: Criar reserva
        R-->>B: Reservado
    else Pe√ßa indispon√≠vel
        I->>P: Criar necessidade de compra
        P-->>B: Aguardando compra
    end
    
    Note over R: Pe√ßa reservada por 30 dias
    
    B->>I: OS iniciada - Consumir pe√ßas
    I->>R: Liberar reserva
    R->>I: Dar baixa no estoque
    I-->>B: Pe√ßas consumidas
```

### Cria√ß√£o de Reserva
```typescript
async function reservePartsFromBudget(budgetId) {
  const budget = await getBudget(budgetId);
  const parts = await getBudgetParts(budgetId);
  
  for (const part of parts) {
    const available = await getPartAvailableQuantity(part.part_id);
    
    if (available >= part.quantity) {
      // Reservar
      await createReservation({
        org_id: budget.org_id,
        part_id: part.part_id,
        quantity: part.quantity,
        reserved_for: 'budget',
        reference_id: budgetId,
        order_id: budget.order_id,
        status: 'reserved',
        reserved_at: new Date(),
        expires_at: addDays(new Date(), 30), // 30 dias
        reserved_by: budget.approved_by
      });
      
      // Atualizar quantidade dispon√≠vel (n√£o altera estoque f√≠sico)
      await updatePartAvailability(part.part_id, -part.quantity);
      
    } else {
      // Reservar dispon√≠vel + criar necessidade de compra para faltante
      const deficit = part.quantity - available;
      
      if (available > 0) {
        await createReservation({...});
        await updatePartAvailability(part.part_id, -available);
      }
      
      await createPurchaseNeed({
        part_id: part.part_id,
        quantity_needed: deficit,
        priority: 'high',
        reason: `Faltante para or√ßamento ${budget.number}`,
        required_by: budget.expected_delivery,
        generated_from: 'budget_approval',
        reference_id: budgetId
      });
    }
  }
}
```

### Libera√ß√£o de Reserva
```typescript
async function releaseReservation(reservationId, quantityUsed) {
  const reservation = await getReservation(reservationId);
  
  if (quantityUsed < reservation.quantity) {
    // Usou menos que reservado - liberar o excedente
    const excess = reservation.quantity - quantityUsed;
    
    await updateReservation(reservationId, {
      quantity: quantityUsed,
      status: 'released',
      released_at: new Date()
    });
    
    await updatePartAvailability(reservation.part_id, excess);
    
  } else {
    // Usou tudo
    await updateReservation(reservationId, {
      status: 'released',
      released_at: new Date()
    });
  }
}
```

### Expira√ß√£o de Reservas
```typescript
// Job di√°rio que verifica reservas expiradas
async function checkExpiredReservations() {
  const expired = await getReservations({
    status: 'reserved',
    expires_at: { lessThan: new Date() }
  });
  
  for (const reservation of expired) {
    // Liberar reserva
    await updateReservation(reservation.id, {
      status: 'expired',
      expired_at: new Date()
    });
    
    // Devolver disponibilidade ao estoque
    await updatePartAvailability(reservation.part_id, reservation.quantity);
    
    // Notificar respons√°vel
    await notify('reservation_expired', {
      reservation_id: reservation.id,
      part: reservation.part_name,
      quantity: reservation.quantity
    });
  }
}
```

---

## ‚ö†Ô∏è Alertas de Estoque

```mermaid
graph TD
    A[Verifica√ß√£o Di√°ria] --> B{Estoque Atual}
    
    B -->|< M√≠nimo| C[Alerta Cr√≠tico]
    B -->|= M√≠nimo| D[Alerta Baixo]
    B -->|< √ìtimo| E[Alerta Aten√ß√£o]
    B -->|>= √ìtimo| F[OK]
    
    C --> G[Criar Necessidade de Compra Urgente]
    D --> H[Notificar Compras]
    E --> I[Monitorar]
    
    style C fill:#ffcdd2
    style D fill:#fff9c4
    style F fill:#c8e6c9
```

### N√≠veis de Alerta
```typescript
// Job di√°rio
async function checkStockLevels() {
  const parts = await getAllActiveParts();
  
  for (const part of parts) {
    const currentQty = await getPartAvailableQuantity(part.id);
    const reserved = await getReservedQuantity(part.id);
    const available = currentQty - reserved;
    
    if (available <= 0 && reserved > 0) {
      // Pe√ßa totalmente reservada
      await createAlert({
        type: 'stock_fully_reserved',
        severity: 'warning',
        title: `${part.name} - Totalmente reservado`,
        description: `Quantidade em estoque: ${currentQty}, Reservado: ${reserved}`,
        reference_id: part.id,
        assigned_to: 'purchasing_team'
      });
      
    } else if (available < part.minimum_stock) {
      // Abaixo do m√≠nimo
      const urgency = available === 0 ? 'critical' : 'high';
      
      await createAlert({
        type: 'stock_below_minimum',
        severity: urgency === 'critical' ? 'critical' : 'warning',
        title: `${part.name} - Estoque cr√≠tico`,
        description: `Dispon√≠vel: ${available}, M√≠nimo: ${part.minimum_stock}`,
        reference_id: part.id,
        assigned_to: 'purchasing_team'
      });
      
      // Criar necessidade de compra autom√°tica
      const quantityToOrder = part.optimal_stock 
        ? part.optimal_stock - available 
        : part.minimum_stock * 2;
      
      await createPurchaseNeed({
        part_id: part.id,
        quantity_needed: quantityToOrder,
        priority: urgency,
        reason: 'stock_below_minimum',
        auto_generated: true
      });
    }
  }
}
```

---

## üìä Contagem F√≠sica (Invent√°rio)

```mermaid
graph TD
    A[Iniciar Invent√°rio] --> B[Definir Escopo]
    B --> C{Tipo}
    
    C -->|Total| D[Todas as Pe√ßas]
    C -->|Parcial| E[Categoria/Localiza√ß√£o]
    C -->|C√≠clico| F[Pe√ßas de Alta Rotatividade]
    
    D --> G[Gerar Lista de Contagem]
    E --> G
    F --> G
    
    G --> H[Realizar Contagem F√≠sica]
    H --> I[Registrar Quantidades]
    I --> J{Diverg√™ncia?}
    
    J -->|Sim| K[Registrar Diferen√ßa]
    J -->|N√£o| L[Confirmar]
    
    K --> M[Ajustar Estoque]
    M --> N[Gerar Relat√≥rio]
    L --> N
```

### Processo de Invent√°rio
```typescript
async function startInventoryCount(inventoryData) {
  // 1. Criar invent√°rio
  const inventory = await createInventory({
    org_id: inventoryData.org_id,
    type: inventoryData.type, // 'full', 'partial', 'cyclic'
    scope: inventoryData.scope, // 'all', 'category', 'location'
    scheduled_date: inventoryData.date,
    status: 'planned',
    created_by: inventoryData.user_id
  });
  
  // 2. Gerar lista de pe√ßas a contar
  let partsToCount = [];
  
  if (inventoryData.type === 'full') {
    partsToCount = await getAllActiveParts();
  } else if (inventoryData.scope === 'category') {
    partsToCount = await getPartsByCategory(inventoryData.category);
  } else if (inventoryData.scope === 'location') {
    partsToCount = await getPartsByLocation(inventoryData.location);
  }
  
  // 3. Criar itens de contagem
  for (const part of partsToCount) {
    await createInventoryCountItem({
      inventory_id: inventory.id,
      part_id: part.id,
      system_quantity: part.current_quantity,
      counted_quantity: null, // A ser preenchido
      variance: null,
      status: 'pending'
    });
  }
  
  return inventory;
}

async function registerCount(itemId, countData) {
  const item = await getInventoryCountItem(itemId);
  
  // Registrar contagem
  await updateInventoryCountItem(itemId, {
    counted_quantity: countData.quantity,
    counted_by: countData.user_id,
    counted_at: new Date(),
    variance: countData.quantity - item.system_quantity,
    notes: countData.notes,
    status: 'counted'
  });
  
  // Se diverg√™ncia, criar ajuste
  if (countData.quantity !== item.system_quantity) {
    const variance = countData.quantity - item.system_quantity;
    
    await createInventoryAdjustment({
      inventory_id: item.inventory_id,
      part_id: item.part_id,
      variance: variance,
      reason: 'physical_count',
      requires_approval: Math.abs(variance) > 10 || 
        (Math.abs(variance) * item.part.unit_cost) > 500,
      status: 'pending_approval'
    });
  }
}

async function finalizeInventory(inventoryId) {
  const inventory = await getInventory(inventoryId);
  
  // Aplicar todos os ajustes aprovados
  const adjustments = await getInventoryAdjustments({
    inventory_id: inventoryId,
    status: 'approved'
  });
  
  for (const adj of adjustments) {
    await applyInventoryAdjustment(adj.id);
  }
  
  // Gerar relat√≥rio
  const report = await generateInventoryReport(inventoryId);
  
  // Concluir
  await updateInventory(inventoryId, {
    status: 'completed',
    completed_at: new Date(),
    report_url: report.url
  });
}
```

---

## üîç Rastreabilidade

### Por Lote
```typescript
interface LotTracking {
  lot_number: string;
  part_id: string;
  quantity: number;
  received_date: Date;
  expiry_date?: Date;
  supplier_id: string;
  purchase_order_id: string;
  quality_status: 'approved' | 'quarantine' | 'rejected';
  current_location: string;
  
  // Movimenta√ß√µes deste lote
  movements: Array<{
    movement_id: string;
    quantity: number;
    date: Date;
    type: 'in' | 'out';
    reference: string;
  }>;
}

// Rastrear onde est√° um lote espec√≠fico
async function trackLot(lotNumber) {
  const lot = await getLot(lotNumber);
  const movements = await getLotMovements(lotNumber);
  const currentStock = await getLotCurrentStock(lotNumber);
  
  return {
    lot_info: lot,
    history: movements,
    current_stock: currentStock,
    used_in_orders: await getOrdersUsingLot(lotNumber)
  };
}
```

### Por N√∫mero de S√©rie (Pe√ßas Cr√≠ticas)
```typescript
// Para pe√ßas de alto valor que precisam rastreamento individual
interface SerialNumberTracking {
  serial_number: string;
  part_id: string;
  received_date: Date;
  supplier_id: string;
  warranty_until?: Date;
  status: 'in_stock' | 'reserved' | 'used' | 'returned';
  
  // Hist√≥rico completo
  history: Array<{
    date: Date;
    action: 'received' | 'reserved' | 'used' | 'returned';
    order_id?: string;
    user_id: string;
  }>;
}
```

---

## üìà Relat√≥rios de Estoque

### 1. Posi√ß√£o de Estoque
- Lista completa de pe√ßas
- Quantidade atual, reservada, dispon√≠vel
- Valor em estoque (custo m√©dio)
- Status de cada pe√ßa

### 2. Curva ABC
- **Classe A**: 20% das pe√ßas que representam 80% do valor
- **Classe B**: 30% das pe√ßas que representam 15% do valor
- **Classe C**: 50% das pe√ßas que representam 5% do valor

### 3. Giro de Estoque
```typescript
turnoverRate = (Custo das Sa√≠das) / (Estoque M√©dio)
```

### 4. Acuracidade de Invent√°rio
```typescript
accuracy = (Itens Corretos / Total de Itens Contados) * 100
```

---

## üîí Permiss√µes

| A√ß√£o | Super Admin | Owner | Admin | Manager | Operator | Viewer |
|------|-------------|-------|-------|---------|----------|--------|
| Ver Estoque | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | üìñ |
| Cadastrar Pe√ßa | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Editar Pe√ßa | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Entrada de Estoque | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úèÔ∏è | ‚ùå |
| Sa√≠da de Estoque | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úèÔ∏è | ‚ùå |
| Ajuste de Estoque | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Fazer Invent√°rio | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úèÔ∏è | ‚ùå |
| Aprovar Ajustes | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |

---

**√öltima Atualiza√ß√£o**: 2025-01-14  
**Vers√£o**: 1.0.0
