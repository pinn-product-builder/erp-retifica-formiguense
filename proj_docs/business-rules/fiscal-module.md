# üßæ M√≥dulo Fiscal - Regras de Neg√≥cio

## üéØ Vis√£o Geral

O M√≥dulo Fiscal do ERP Ret√≠fica gerencia toda a tributa√ß√£o, obriga√ß√µes acess√≥rias e apura√ß√£o de impostos, garantindo conformidade com a legisla√ß√£o brasileira para os principais regimes tribut√°rios.

---

## üìã Regimes Tribut√°rios Suportados

### 1. Simples Nacional
**P√∫blico-alvo**: Empresas com faturamento at√© R$ 4,8 milh√µes/ano

**Caracter√≠sticas**:
- Tributa√ß√£o simplificada em guia √∫nica (DAS)
- Al√≠quotas progressivas por faixa de faturamento
- Menos obriga√ß√µes acess√≥rias
- N√£o destaca impostos na nota fiscal

**Anexos Aplic√°veis para Ret√≠ficas**:
- **Anexo III**: Servi√ßos (al√≠quota 6% a 33%)
- **Anexo II**: Ind√∫stria (se fabricar pe√ßas)

**Impostos inclu√≠dos no DAS**:
- IRPJ, CSLL, PIS, COFINS, IPI, CPP, ICMS/ISS

```typescript
// C√°lculo simplificado (Anexo III)
const faturamento12meses = 180000.00;
const faixaAtual = identificarFaixa(faturamento12meses);

// Faixas do Anexo III (valores 2024)
const tabela = [
  { limite: 180000, aliquota: 0.06, deducao: 0 },
  { limite: 360000, aliquota: 0.112, deducao: 9360 },
  { limite: 720000, aliquota: 0.135, deducao: 17640 },
  // ... demais faixas
];

const aliquotaEfetiva = (faturamento12meses * faixaAtual.aliquota - faixaAtual.deducao) / faturamento12meses;
const impostoDevido = valorNota * aliquotaEfetiva;
```

### 2. Lucro Presumido
**P√∫blico-alvo**: Empresas com faturamento at√© R$ 78 milh√µes/ano

**Caracter√≠sticas**:
- Base de c√°lculo presumida (32% da receita bruta para servi√ßos)
- Apura√ß√£o trimestral (IRPJ e CSLL)
- Destaca impostos na nota
- Mais obriga√ß√µes que Simples

**Impostos**:
- **IRPJ**: 15% sobre lucro presumido (+ 10% sobre excedente de R$ 60k/trimestre)
- **CSLL**: 9% sobre lucro presumido
- **PIS**: 0,65% sobre faturamento
- **COFINS**: 3% sobre faturamento
- **ISS**: Varia por munic√≠pio (2% a 5%)

```typescript
// Exemplo de c√°lculo
const faturamentoTrimestre = 150000.00;
const lucroPresumido = faturamentoTrimestre * 0.32; // R$ 48.000

const irpj = lucroPresumido * 0.15; // R$ 7.200
const csll = lucroPresumido * 0.09; // R$ 4.320
const pis = faturamentoTrimestre * 0.0065; // R$ 975
const cofins = faturamentoTrimestre * 0.03; // R$ 4.500
const iss = faturamentoTrimestre * 0.05; // R$ 7.500 (5% exemplo)

const totalImpostos = irpj + csll + pis + cofins + iss; // R$ 24.495
```

### 3. Lucro Real
**P√∫blico-alvo**: Empresas com faturamento > R$ 78 milh√µes ou obrigadas por atividade

**Caracter√≠sticas**:
- Tributa√ß√£o sobre lucro cont√°bil efetivo
- Apura√ß√£o trimestral ou anual (com antecipa√ß√µes mensais)
- Permite compensa√ß√£o de preju√≠zos
- M√°ximo de obriga√ß√µes acess√≥rias

**Impostos**:
- **IRPJ**: 15% + 10% (sobre lucro real)
- **CSLL**: 9% (sobre lucro real)
- **PIS**: 1,65% (n√£o cumulativo)
- **COFINS**: 7,6% (n√£o cumulativo)
- **ISS**: Varia por munic√≠pio

---

## üèõÔ∏è Jurisdi√ß√µes Fiscais

```mermaid
graph TD
    A[Opera√ß√£o Fiscal] --> B{Tipo de Tributo}
    
    B --> C[Federal]
    B --> D[Estadual]
    B --> E[Municipal]
    
    C --> C1[IRPJ]
    C --> C2[CSLL]
    C --> C3[PIS]
    C --> C4[COFINS]
    C --> C5[IPI]
    
    D --> D1[ICMS]
    
    E --> E1[ISS]
    
    style C fill:#fff9c4
    style D fill:#c8e6c9
    style E fill:#b3e5fc
```

### Federal
- **Respons√°vel**: Receita Federal do Brasil
- **Impostos**: IRPJ, CSLL, PIS, COFINS, IPI
- **Obriga√ß√µes**: DCTF, EFD-Contribui√ß√µes, ECF

### Estadual
- **Respons√°vel**: SEFAZ de cada estado
- **Impostos**: ICMS (quando aplic√°vel - venda de pe√ßas)
- **Obriga√ß√µes**: SPED Fiscal, GIA

### Municipal
- **Respons√°vel**: Prefeitura local
- **Impostos**: ISS (Imposto Sobre Servi√ßos)
- **Obriga√ß√µes**: Nota Fiscal Eletr√¥nica de Servi√ßos (NFS-e)

---

## üìä Classifica√ß√µes Fiscais

### 1. NCM (Nomenclatura Comum do Mercosul)
C√≥digo de 8 d√≠gitos para classificar mercadorias (pe√ßas):

**Exemplos**:
- **8409.91.10**: Blocos de cilindros, cabe√ßotes
- **8409.91.20**: Bielas
- **8409.91.30**: Virabrequins
- **8409.91.40**: Pist√µes
- **8409.91.90**: Outras pe√ßas de motores

### 2. CFOP (C√≥digo Fiscal de Opera√ß√µes e Presta√ß√µes)
C√≥digo de 4 d√≠gitos que identifica a natureza da opera√ß√£o:

**Sa√≠das (Vendas/Servi√ßos)**:
- **5.101**: Venda de produ√ß√£o pr√≥pria (dentro do estado)
- **5.102**: Venda de mercadoria adquirida para revenda
- **5.933**: Presta√ß√£o de servi√ßo tributado pelo ISSQN (ret√≠fica)
- **6.101**: Venda para fora do estado
- **6.933**: Presta√ß√£o de servi√ßo fora do estado

**Entradas (Compras)**:
- **1.101**: Compra para industrializa√ß√£o
- **1.102**: Compra para revenda
- **2.101**: Compra de fora do estado

### 3. CST/CSOSN (C√≥digo de Situa√ß√£o Tribut√°ria)

#### CST (Regimes Lucro Presumido/Real)
- **00**: Tributada integralmente
- **20**: Com redu√ß√£o de base de c√°lculo
- **30**: Isenta ou n√£o tributada
- **40**: Isenta
- **41**: N√£o tributada
- **60**: ICMS cobrado anteriormente por substitui√ß√£o tribut√°ria

#### CSOSN (Simples Nacional)
- **101**: Tributada pelo Simples Nacional
- **102**: Sem permiss√£o de cr√©dito
- **103**: Isen√ß√£o do ICMS para faixa de receita bruta
- **201**: Tributada com permiss√£o de cr√©dito
- **500**: ICMS cobrado anteriormente

---

## üí∞ Tipos de Impostos

### 1. ISS (Imposto Sobre Servi√ßos)
**Incid√™ncia**: Servi√ßos de ret√≠fica, montagem, diagn√≥stico

**Al√≠quota**: 2% a 5% (varia por munic√≠pio)

**Base de c√°lculo**: Valor total do servi√ßo

**Respons√°vel**: Tomador ou prestador (conforme legisla√ß√£o municipal)

```typescript
// C√°lculo ISS
const valorServico = 5000.00;
const aliquotaISS = 0.05; // 5% (exemplo S√£o Paulo)
const iss = valorServico * aliquotaISS; // R$ 250,00
```

### 2. ICMS (Imposto sobre Circula√ß√£o de Mercadorias)
**Incid√™ncia**: Venda de pe√ßas (n√£o se aplica a servi√ßos)

**Al√≠quota**: Varia por estado (7% a 18%)

**Observa√ß√£o**: Ret√≠ficas geralmente N√ÉO s√£o contribuintes de ICMS, exceto quando vendem pe√ßas como com√©rcio.

### 3. PIS (Programa de Integra√ß√£o Social)
**Regimes**:
- **Cumulativo**: 0,65% (Lucro Presumido)
- **N√£o cumulativo**: 1,65% (Lucro Real) - permite cr√©ditos

### 4. COFINS (Contribui√ß√£o para Financiamento da Seguridade Social)
**Regimes**:
- **Cumulativo**: 3% (Lucro Presumido)
- **N√£o cumulativo**: 7,6% (Lucro Real) - permite cr√©ditos

### 5. IRPJ (Imposto de Renda Pessoa Jur√≠dica)
**Al√≠quota**: 15% + 10% (sobre lucro > R$ 20k/m√™s)

**Base de c√°lculo**:
- Lucro Real: Lucro cont√°bil ajustado
- Lucro Presumido: 32% da receita bruta (servi√ßos)

### 6. CSLL (Contribui√ß√£o Social sobre o Lucro L√≠quido)
**Al√≠quota**: 9%

**Base de c√°lculo**: Mesma do IRPJ

---

## üßÆ C√°lculo de Impostos no Or√ßamento/Nota Fiscal

```mermaid
sequenceDiagram
    participant U as Usu√°rio
    participant B as Or√ßamento
    participant F as M√≥dulo Fiscal
    participant C as Config. Fiscal
    participant DB as Database
    
    U->>B: Preenche or√ßamento
    B->>F: Solicita c√°lculo de impostos
    F->>C: Buscar regime tribut√°rio
    C-->>F: Simples Nacional
    F->>F: Identificar CST/CFOP
    F->>F: Calcular impostos por item
    F->>DB: Registrar c√°lculo
    F-->>B: Retorna impostos calculados
    B-->>U: Exibe total com impostos
```

### Exemplo Pr√°tico: Or√ßamento Completo

```typescript
// Dados do or√ßamento
const orcamento = {
  servicos: 3500.00,
  pecas: 2500.00,
  maoDeObra: 1200.00
};

const subtotal = 7200.00;

// Configura√ß√£o fiscal da empresa
const regime = "simples_nacional";
const aliquotaSimples = 0.065; // 6.5% (Anexo III - faixa exemplo)

// C√°lculo de impostos
if (regime === "simples_nacional") {
  // Simples n√£o destaca impostos, mas pode informar
  const impostoAproximado = subtotal * aliquotaSimples; // R$ 468,00
  const total = subtotal; // N√£o adiciona ao valor (j√° incluso)
  
  // Informa√ß√£o na nota: "Tributos aproximados: R$ 468,00"
  
} else if (regime === "lucro_presumido") {
  // Destaca impostos
  const pis = subtotal * 0.0065; // R$ 46,80
  const cofins = subtotal * 0.03; // R$ 216,00
  const iss = orcamento.servicos * 0.05; // R$ 175,00 (s√≥ sobre servi√ßos)
  
  const totalImpostos = pis + cofins + iss; // R$ 437,80
  const total = subtotal + totalImpostos; // R$ 7.637,80
}
```

---

## üìÅ Obriga√ß√µes Acess√≥rias

### 1. SPED Fiscal (EFD ICMS/IPI)
**Quem entrega**: Contribuintes de ICMS/IPI

**Periodicidade**: Mensal

**Prazo**: At√© o dia 25 do m√™s seguinte

**Conte√∫do**:
- Todas as entradas e sa√≠das de mercadorias
- Invent√°rio
- Apura√ß√£o de ICMS/IPI

**Status no ERP**: ‚ö†Ô∏è **Parcialmente implementado** (ret√≠ficas geralmente n√£o precisam)

### 2. EFD-Contribui√ß√µes (SPED PIS/COFINS)
**Quem entrega**: Pessoas jur√≠dicas do Lucro Presumido/Real

**Periodicidade**: Mensal

**Prazo**: At√© o 10¬∫ dia √∫til do 2¬∫ m√™s seguinte

**Conte√∫do**:
- Receitas
- Cr√©ditos de PIS/COFINS (n√£o cumulativo)
- Apura√ß√£o

**Status no ERP**: ‚úÖ **Implementado** (gera√ß√£o de arquivo)

### 3. DCTF (Declara√ß√£o de D√©bitos e Cr√©ditos Tribut√°rios Federais)
**Quem entrega**: Todas as pessoas jur√≠dicas (exceto Simples em alguns casos)

**Periodicidade**: Mensal

**Prazo**: At√© o 15¬∫ dia √∫til do 2¬∫ m√™s seguinte

**Conte√∫do**:
- D√©bitos federais (IRPJ, CSLL, PIS, COFINS, etc.)
- Pagamentos efetuados

**Status no ERP**: üîÑ **Em desenvolvimento**

### 4. ECF (Escritura√ß√£o Cont√°bil Fiscal)
**Quem entrega**: Pessoas jur√≠dicas do Lucro Presumido/Real

**Periodicidade**: Anual

**Prazo**: √öltimo dia √∫til de julho do ano seguinte

**Conte√∫do**:
- Lucro cont√°bil
- Ajustes fiscais
- Apura√ß√£o de IRPJ e CSLL

**Status no ERP**: üîÑ **Em desenvolvimento**

### 5. DEFIS (Declara√ß√£o de Informa√ß√µes Socioecon√¥micas e Fiscais)
**Quem entrega**: Empresas do Simples Nacional

**Periodicidade**: Anual

**Prazo**: 31 de mar√ßo

**Conte√∫do**:
- Faturamento mensal
- Dados de empregados
- Informa√ß√µes patrimoniais

**Status no ERP**: üîÑ **Planejado**

### 6. NFS-e (Nota Fiscal de Servi√ßos Eletr√¥nica)
**Quem emite**: Prestadores de servi√ßos

**Quando**: A cada servi√ßo prestado

**Integra√ß√£o**: Via API da prefeitura (cada cidade tem seu padr√£o)

**Status no ERP**: ‚úÖ **Implementado** (integra√ß√£o configur√°vel por munic√≠pio)

---

## üìä Apura√ß√£o Fiscal Mensal

```mermaid
graph TD
    A[In√≠cio do M√™s] --> B[Coletar Dados Fiscais]
    B --> C[Separar por Tipo de Tributo]
    
    C --> D[Federal]
    C --> E[Municipal]
    
    D --> D1[Calcular PIS/COFINS]
    D --> D2[Calcular IRPJ/CSLL se trimestre]
    D1 --> D3[Gerar DARF Federal]
    D2 --> D3
    
    E --> E1[Calcular ISS]
    E1 --> E2[Gerar Guia Municipal]
    
    D3 --> F[Registrar Pagamentos]
    E2 --> F
    
    F --> G[Gerar Relat√≥rios]
    G --> H[Enviar Obriga√ß√µes Acess√≥rias]
    H --> I[Concluir Apura√ß√£o]
    
    style D3 fill:#fff9c4
    style E2 fill:#b3e5fc
    style H fill:#c8e6c9
```

### Processo Automatizado

```typescript
// Executado automaticamente no dia 1¬∫ de cada m√™s
async function apuracaoFiscalMensal(orgId, referenceMonth) {
  // 1. Coletar todos os or√ßamentos aprovados do m√™s
  const budgets = await getApprovedBudgets(orgId, referenceMonth);
  
  // 2. Coletar todas as notas fiscais emitidas
  const invoices = await getIssuedInvoices(orgId, referenceMonth);
  
  // 3. Calcular totais por tipo de receita
  const totals = {
    receita_servicos: 0,
    receita_pecas: 0,
    receita_total: 0
  };
  
  for (const invoice of invoices) {
    totals.receita_servicos += invoice.services_value;
    totals.receita_pecas += invoice.parts_value;
  }
  totals.receita_total = totals.receita_servicos + totals.receita_pecas;
  
  // 4. Buscar regime tribut√°rio
  const fiscalConfig = await getFiscalConfig(orgId);
  
  // 5. Calcular impostos conforme regime
  let impostos = {};
  
  if (fiscalConfig.regime === 'simples_nacional') {
    impostos = calcularSimples(totals.receita_total, fiscalConfig);
  } else if (fiscalConfig.regime === 'lucro_presumido') {
    impostos = calcularLucroPresumido(totals, fiscalConfig);
  } else if (fiscalConfig.regime === 'lucro_real') {
    impostos = calcularLucroReal(totals, fiscalConfig);
  }
  
  // 6. Registrar apura√ß√£o
  const apuracao = await createFiscalAppraisal({
    org_id: orgId,
    reference_month: referenceMonth,
    revenue: totals,
    taxes: impostos,
    status: 'pending_payment'
  });
  
  // 7. Gerar guias de pagamento (DARFs, ISS)
  await generatePaymentSlips(apuracao);
  
  // 8. Notificar respons√°vel fiscal
  await notifyFiscalManager(orgId, apuracao);
  
  return apuracao;
}
```

---

## üìÑ Relat√≥rios Fiscais

### 1. Relat√≥rio de Faturamento Mensal
- Receitas por tipo (servi√ßos, pe√ßas, m√£o de obra)
- Compara√ß√£o m√™s a m√™s
- Gr√°fico de evolu√ß√£o
- Exporta√ß√£o para Excel/PDF

### 2. Relat√≥rio de Impostos Pagos
- Por tipo de imposto
- Por per√≠odo
- Compara√ß√£o com faturamento (carga tribut√°ria %)
- Proje√ß√£o de impostos futuros

### 3. Livro de Registro de Servi√ßos Prestados
- Todas as NFS-e emitidas
- Dados do tomador
- Valores e impostos
- Base de c√°lculo ISS

### 4. Demonstrativo de Apura√ß√£o
- Base de c√°lculo de cada imposto
- Al√≠quotas aplicadas
- Valores devidos
- Vencimentos e pagamentos

### 5. Posi√ß√£o de Obriga√ß√µes Acess√≥rias
- Obriga√ß√µes do m√™s/ano
- Status (pendente, entregue, atrasada)
- Prazos
- Alertas de vencimento

---

## ‚öôÔ∏è Configura√ß√£o Fiscal da Empresa

### Dados Obrigat√≥rios
```typescript
{
  "org_id": "uuid",
  "tax_regime": "simples_nacional" | "lucro_presumido" | "lucro_real",
  "cnae_principal": "2950-6/00", // Recondicionamento de motores
  "state_registration": "123.456.789", // IE (se contribuinte ICMS)
  "municipal_registration": "98765432", // IM
  "iss_rate": 0.05, // Al√≠quota ISS do munic√≠pio
  "simples_annex": "III", // Se Simples Nacional
  "accountant": {
    "name": "Jos√© Silva",
    "cpf": "123.456.789-00",
    "crc": "CRC-SP 123456/O-0",
    "email": "contador@empresa.com.br",
    "phone": "(11) 99999-9999"
  },
  "nfse_config": {
    "city_code": "3550308", // S√£o Paulo
    "provider": "ginfes", // Padr√£o da prefeitura
    "username": "empresa_login",
    "password_encrypted": "...",
    "certificate": "..." // Certificado digital A1/A3
  }
}
```

---

## üîí Permiss√µes

| A√ß√£o | Super Admin | Owner | Admin | Manager | Operator | Viewer |
|------|-------------|-------|-------|---------|----------|--------|
| Ver Relat√≥rios Fiscais | ‚úÖ | ‚úÖ | ‚úÖ | üìñ | ‚ùå | ‚ùå |
| Configurar Regime | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Gerar SPED | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Fazer Apura√ß√£o | ‚úÖ | ‚úÖ | ‚úÖ | üìñ | ‚ùå | ‚ùå |
| Emitir NFS-e | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úèÔ∏è | ‚ùå |

---

## üö® Alertas Fiscais

### Autom√°ticos
- ‚ö†Ô∏è Obriga√ß√£o acess√≥ria vencendo em 5 dias
- üî¥ Obriga√ß√£o atrasada
- üí∞ Impostos a pagar no m√™s
- üìä Mudan√ßa de faixa do Simples Nacional
- üéØ Faturamento pr√≥ximo ao limite do regime

### Configur√°veis
- Meta de faturamento mensal
- Carga tribut√°ria acima de X%
- Necessidade de provisionamento de impostos

---

**√öltima Atualiza√ß√£o**: 2025-01-14  
**Vers√£o**: 1.0.0
