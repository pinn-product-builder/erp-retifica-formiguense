# üîß Opera√ß√µes e Workflow - Regras de Neg√≥cio

## üéØ Vis√£o Geral

O m√≥dulo de Opera√ß√µes √© o cora√ß√£o do ERP Ret√≠fica, gerenciando todo o ciclo de vida de um motor desde a entrada at√© a entrega, passando por diagn√≥stico, or√ßamento, execu√ß√£o e controle de qualidade.

---

## üìã Fluxo Completo de Opera√ß√µes

```mermaid
graph TD
    A[Cliente Traz Motor] --> B[Recep√ß√£o/Check-in]
    B --> C[OS Criada]
    C --> D[Diagn√≥stico Inicial]
    D --> E{Necessita Or√ßamento?}
    E -->|Sim| F[Criar Or√ßamento]
    E -->|N√£o| G[Iniciar Workflow]
    F --> H{Or√ßamento Aprovado?}
    H -->|Sim| I[Reservar Pe√ßas]
    H -->|N√£o| J[Aguardando Cliente]
    I --> G
    G --> K[Workflow Kanban - 14 Etapas]
    K --> L[Controle de Qualidade]
    L --> M{Aprovado?}
    M -->|Sim| N[Pronto para Entrega]
    M -->|N√£o| K
    N --> O[Entregue ao Cliente]
    O --> P[Per√≠odo de Garantia]
```

---

## üö™ 1. Recep√ß√£o de Motores (Check-in)

### Formul√°rio de Entrada
Ao receber um motor, o usu√°rio preenche:

#### **Dados do Cliente**
- Nome/Raz√£o Social
- CPF/CNPJ
- Telefone(s)
- Email (opcional)
- Endere√ßo completo

#### **Dados do Ve√≠culo**
- Placa (formato: ABC-1234 ou ABC1D23)
- Marca/Modelo
- Ano/Modelo
- Cor (opcional)
- Hod√¥metro/Hor√≠metro

#### **Dados do Motor**
- **Tipo de Motor**: Sele√ß√£o de tipos cadastrados
  - Diesel 4 cilindros
  - Diesel 6 cilindros
  - Diesel V8
  - Gasolina 4 cilindros
  - Gasolina 6 cilindros
  - Gasolina V6/V8
  - Flex
  - Customizados
- **N√∫mero de S√©rie** (opcional)
- **Aplica√ß√£o**: Caminh√£o, Carro, M√°quina Agr√≠cola, Gerador, etc.

#### **Motivo da Entrada**
- ‚öôÔ∏è Ret√≠fica completa
- üîç Diagn√≥stico
- üîß Manuten√ß√£o preventiva
- üõ†Ô∏è Reparo espec√≠fico
- üîÑ Revis√£o
- üìù Outro (descrever)

#### **Sintomas Relatados**
Campo de texto livre para descrever o problema:
- Barulho no motor
- Perda de pot√™ncia
- Superaquecimento
- Consumo excessivo de √≥leo
- Etc.

#### **Estado Visual Inicial**
- Fotos do motor (at√© 10)
- Observa√ß√µes de danos externos
- Estado de limpeza
- Componentes faltantes

### Gera√ß√£o Autom√°tica da OS
Ao salvar o check-in:
```typescript
// OS criada automaticamente
{
  "number": "OS-20250114-0001", // Auto-incrementado diariamente
  "status": "checkin", // Status inicial
  "customer_id": "uuid",
  "vehicle_data": {...},
  "engine_data": {...},
  "entry_reason": "Ret√≠fica completa",
  "symptoms": "Motor batendo, perda de compress√£o",
  "created_by": "user_id",
  "created_at": "2025-01-14T10:30:00Z",
  "expected_delivery": null, // Ser√° definido ap√≥s or√ßamento
  "org_id": "current_org"
}
```

---

## üîç 2. Sistema de Diagn√≥stico

### Checklists Din√¢micos por Componente

O sistema oferece checklists especializados para cada tipo de componente:

#### **Componentes Dispon√≠veis**
1. **Bloco do Motor** (cylinder_block)
2. **Eixo Comando** (camshaft)
3. **Virabrequim** (crankshaft)
4. **Bielas** (connecting_rods)
5. **Cabe√ßote** (cylinder_head)
6. **Pist√µes** (pistons)

```mermaid
graph LR
    A[Selecionar Componente] --> B[Carregar Checklist]
    B --> C[Responder Perguntas]
    C --> D[Anexar Fotos]
    D --> E{Todas Respondidas?}
    E -->|N√£o| C
    E -->|Sim| F[Gerar Servi√ßos Sugeridos]
    F --> G[Salvar Diagn√≥stico]
```

### Estrutura do Checklist

#### Exemplo: Checklist de Bloco do Motor
```json
{
  "component": "bloco",
  "questions": [
    {
      "id": "q1",
      "text": "O bloco apresenta trincas vis√≠veis?",
      "type": "yes_no",
      "critical": true,
      "photos_required": true
    },
    {
      "id": "q2",
      "text": "Medida do di√¢metro do cilindro 1 (mm)",
      "type": "number",
      "unit": "mm",
      "tolerance": {
        "min": 85.0,
        "max": 86.5
      }
    },
    {
      "id": "q3",
      "text": "Estado dos alojamentos de mancais",
      "type": "select",
      "options": ["Perfeito", "Bom", "Desgastado", "Danificado"]
    }
  ]
}
```

### Tipos de Respostas
- **yes_no**: Sim/N√£o
- **text**: Texto livre
- **number**: Valor num√©rico (com toler√¢ncias)
- **select**: Sele√ß√£o √∫nica
- **multi_select**: Sele√ß√£o m√∫ltipla
- **photo**: Foto obrigat√≥ria

### Fotos do Diagn√≥stico
- **Limite**: At√© 20 fotos por componente
- **Formato**: JPG, PNG, HEIC
- **Tamanho m√°ximo**: 10MB por foto
- **Armazenamento**: Supabase Storage (`diagnostic-photos/`)
- **Vincula√ß√£o**: Cada foto pode ser vinculada a uma pergunta espec√≠fica

### Servi√ßos Gerados Automaticamente
Com base nas respostas, o sistema sugere servi√ßos:
```typescript
// Exemplo de l√≥gica de sugest√£o
if (bloco.q1 === 'yes') { // Trinca vis√≠vel
  suggestedServices.push({
    service: "Solda de trinca em bloco",
    estimated_cost: 1500.00,
    urgency: "critical"
  });
}

if (bloco.q2 > 86.0) { // Fora de toler√¢ncia
  suggestedServices.push({
    service: "Ret√≠fica de cilindros",
    estimated_cost: 800.00,
    urgency: "high"
  });
}
```

### Estados do Diagn√≥stico
- `in_progress`: Em andamento
- `completed`: Conclu√≠do
- `reviewed`: Revisado por gerente
- `approved_for_budget`: Aprovado para or√ßamento

---

## üí∞ 3. Cria√ß√£o de Or√ßamentos

### Fluxo de Cria√ß√£o
```mermaid
sequenceDiagram
    participant T as T√©cnico
    participant S as Sistema
    participant D as Diagn√≥stico
    participant B as Or√ßamento
    participant E as Estoque
    
    T->>S: Criar Or√ßamento para OS
    S->>D: Buscar servi√ßos sugeridos
    D-->>S: Lista de servi√ßos
    S-->>T: Formul√°rio pr√©-preenchido
    T->>T: Ajustar servi√ßos e adicionar pe√ßas
    T->>S: Salvar or√ßamento
    S->>E: Verificar disponibilidade de pe√ßas
    E-->>S: Status das pe√ßas
    S->>B: Criar registro de or√ßamento
    B-->>T: Or√ßamento criado com sucesso
```

### Itens do Or√ßamento

#### **Servi√ßos**
```typescript
{
  "service_name": "Ret√≠fica de cilindros",
  "description": "Brunimento e ret√≠fica de 4 cilindros",
  "quantity": 4,
  "unit_price": 200.00,
  "total": 800.00,
  "estimated_hours": 6
}
```

#### **Pe√ßas**
```typescript
{
  "part_id": "uuid",
  "part_name": "Pist√£o STD",
  "part_code": "PST-001",
  "quantity": 4,
  "unit_price": 150.00,
  "total": 600.00,
  "in_stock": true,
  "supplier": "Mahle"
}
```

#### **M√£o de Obra**
```typescript
{
  "description": "Montagem completa do motor",
  "hours": 12,
  "hour_rate": 80.00,
  "total": 960.00
}
```

### C√°lculo Autom√°tico
```typescript
// F√≥rmula de c√°lculo
subtotal = sum(services) + sum(parts) + sum(labor);
discount = subtotal * (discount_percentage / 100);
subtotal_after_discount = subtotal - discount;

// Impostos (se m√≥dulo fiscal ativo)
taxes = calculateTaxes(subtotal_after_discount, tax_regime);

total = subtotal_after_discount + taxes;
```

### Aprova√ß√£o de Or√ßamento
Ver: [budgets-approval.md](./budgets-approval.md)

---

## üîÑ 4. Workflow Kanban (14 Etapas)

```mermaid
graph LR
    A[1.Entrada] --> B[2.Desmontagem]
    B --> C[3.Limpeza]
    C --> D[4.Inspe√ß√£o]
    D --> E[5.Usinagem]
    E --> F[6.Montagem]
    F --> G[7.Teste]
    G --> H[8.Metrologia]
    H --> I[9.Qualidade]
    I --> J[10.Pintura]
    J --> K[11.Pronto]
    K --> L[12.Entregue]
    L --> M[13.Garantia]
    
    style A fill:#e3f2fd
    style D fill:#fff3e0
    style I fill:#fce4ec
    style K fill:#e8f5e9
    style L fill:#f3e5f5
    style M fill:#e0f2f1
```

### Etapas Padr√£o

#### **1. Entrada (Check-in)**
- **Status**: `checkin`
- **Cor**: Azul claro
- **Respons√°vel**: Recep√ß√£o
- **A√ß√µes**:
  - Preencher formul√°rio de entrada
  - Tirar fotos iniciais
  - Criar OS
- **Pr√≥ximo**: Desmontagem

#### **2. Desmontagem**
- **Status**: `disassembly`
- **Cor**: Roxo
- **Respons√°vel**: T√©cnico
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Drenar todos os fluidos
  - [ ] Fotografar antes da desmontagem
  - [ ] Identificar todas as pe√ßas
  - [ ] Separar parafusos e porcas por conjunto
- **Pr√≥ximo**: Limpeza

#### **3. Limpeza**
- **Status**: `cleaning`
- **Cor**: Verde claro
- **Respons√°vel**: Operador de limpeza
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Limpeza com desengraxante
  - [ ] Secagem completa
  - [ ] Verifica√ß√£o visual de trincas √≥bvias
- **Pr√≥ximo**: Inspe√ß√£o

#### **4. Inspe√ß√£o e Diagn√≥stico**
- **Status**: `inspection`
- **Cor**: Laranja
- **Respons√°vel**: T√©cnico especializado
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Medi√ß√µes dimensionais
  - [ ] Teste de estanqueidade
  - [ ] Inspe√ß√£o por l√≠quido penetrante
  - [ ] Diagn√≥stico completo de todos os componentes
- **Bloqueio**: N√£o pode avan√ßar sem diagn√≥stico aprovado
- **Pr√≥ximo**: Usinagem ou Or√ßamento

#### **5. Usinagem**
- **Status**: `machining`
- **Cor**: Cinza
- **Respons√°vel**: Operador de m√°quinas
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Ret√≠fica de cilindros executada
  - [ ] Brunimento conclu√≠do
  - [ ] Ret√≠fica de virabrequim (se necess√°rio)
  - [ ] Ret√≠fica de comando (se necess√°rio)
  - [ ] Medi√ß√µes p√≥s-usinagem registradas
- **Pr√≥ximo**: Montagem

#### **6. Montagem**
- **Status**: `assembly`
- **Cor**: Azul
- **Respons√°vel**: Montador
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Pe√ßas novas instaladas conforme or√ßamento
  - [ ] Torques aplicados conforme especifica√ß√£o
  - [ ] Folgas conferidas
  - [ ] Registros fotogr√°ficos de etapas cr√≠ticas
- **Pr√≥ximo**: Teste

#### **7. Teste de Bancada**
- **Status**: `testing`
- **Cor**: Amarelo
- **Respons√°vel**: T√©cnico de testes
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Teste de compress√£o
  - [ ] Teste de press√£o de √≥leo
  - [ ] Teste de partida a frio
  - [ ] Teste de temperatura de trabalho
  - [ ] Verifica√ß√£o de ru√≠dos anormais
- **Bloqueio**: N√£o pode avan√ßar se falhar no teste
- **Pr√≥ximo**: Metrologia

#### **8. Metrologia**
- **Status**: `metrology`
- **Cor**: Roxo escuro
- **Respons√°vel**: Inspetor de qualidade
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Medi√ß√µes finais conferidas
  - [ ] Toler√¢ncias dentro do especificado
  - [ ] Relat√≥rio de metrologia gerado
- **Pr√≥ximo**: Controle de Qualidade

#### **9. Controle de Qualidade**
- **Status**: `quality_control`
- **Cor**: Rosa
- **Respons√°vel**: Supervisor de qualidade
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Inspe√ß√£o visual final
  - [ ] Confer√™ncia de todos os documentos
  - [ ] Verifica√ß√£o de garantia
  - [ ] Aprova√ß√£o final assinada
- **Bloqueio**: N√£o pode avan√ßar sem aprova√ß√£o do supervisor
- **Pr√≥ximo**: Pintura ou Pronto

#### **10. Pintura (Opcional)**
- **Status**: `painting`
- **Cor**: Laranja claro
- **Respons√°vel**: Pintor
- **Checklist**: ‚úÖ
  - [ ] Prepara√ß√£o da superf√≠cie
  - [ ] Aplica√ß√£o de primer
  - [ ] Pintura final
  - [ ] Secagem completa
- **Pr√≥ximo**: Pronto

#### **11. Pronto para Entrega**
- **Status**: `ready`
- **Cor**: Verde
- **Respons√°vel**: Gerente de opera√ß√µes
- **A√ß√µes**:
  - Avisar cliente
  - Gerar documenta√ß√£o de entrega
  - Preparar nota fiscal (se aplic√°vel)
- **Pr√≥ximo**: Entregue

#### **12. Entregue**
- **Status**: `delivered`
- **Cor**: Roxo
- **Respons√°vel**: Recep√ß√£o/Expedi√ß√£o
- **Checklist Obrigat√≥rio**: ‚úÖ
  - [ ] Cliente identificado (CPF/RG)
  - [ ] Assinatura do cliente na OS
  - [ ] Pagamento confirmado
  - [ ] Termo de garantia entregue
  - [ ] Manual de instru√ß√µes entregue
- **Pr√≥ximo**: Garantia

#### **13. Em Garantia**
- **Status**: `warranty`
- **Cor**: Azul claro
- **Respons√°vel**: P√≥s-venda
- **Dura√ß√£o**: Configur√°vel (padr√£o: 90 dias)
- **A√ß√µes**:
  - Monitorar per√≠odo de garantia
  - Registrar reclama√ß√µes (se houver)
  - Agendar revis√µes preventivas

#### **14. Finalizado**
- **Status**: `finished`
- **Cor**: Cinza claro
- **Respons√°vel**: Sistema (autom√°tico ap√≥s garantia)
- **A√ß√µes**:
  - Arquivar documenta√ß√£o
  - Calcular estat√≠sticas de performance
  - Solicitar avalia√ß√£o do cliente (NPS)

---

## ‚úÖ Sistema de Checklists Obrigat√≥rios

### Bloqueio de Avan√ßo
Etapas com checklists obrigat√≥rios (marcados com ‚úÖ) **n√£o podem avan√ßar** para a pr√≥xima etapa sem que todos os itens estejam marcados.

```typescript
// Valida√ß√£o de avan√ßo
function canAdvanceToNextStep(order, nextStatus) {
  const currentStepConfig = getStepConfig(order.status);
  
  if (currentStepConfig.requires_checklist) {
    const checklist = getOrderChecklist(order.id, order.status);
    
    if (!checklist || !checklist.all_items_checked) {
      throw new Error("Checklist obrigat√≥rio n√£o conclu√≠do");
    }
  }
  
  return true;
}
```

### Exce√ß√µes (Permiss√£o Especial)
Apenas **Admin, Owner ou Super Admin** podem for√ßar o avan√ßo sem checklist completo (com justificativa registrada).

---

## üéØ Gest√£o de Componentes

### Movimenta√ß√£o por Componente
Cada motor pode ser desmembrado em componentes que seguem fluxos independentes:

```mermaid
graph TD
    A[Motor Completo - OS #001] --> B[Bloco]
    A --> C[Comando]
    A --> D[Virabrequim]
    A --> E[Bielas x4]
    A --> F[Cabe√ßote]
    
    B --> B1[Inspe√ß√£o]
    B1 --> B2[Usinagem]
    B2 --> B3[Montagem]
    
    C --> C1[Inspe√ß√£o]
    C1 --> C2[Ret√≠fica]
    C2 --> C3[Pronto]
    
    D --> D1[Inspe√ß√£o]
    D1 --> D2[Ret√≠fica]
    D2 --> D3[Pronto]
```

### Vis√£o no Kanban
- **Card da OS**: Mostra status geral
- **Indicador de progresso**: Percentual de componentes conclu√≠dos
- **Drill-down**: Clique para ver detalhes de cada componente
- **Alerta**: Se algum componente est√° atrasado

---

## üîí Permiss√µes por Etapa

| A√ß√£o | Super Admin | Owner | Admin | Manager | Operator | Viewer |
|------|-------------|-------|-------|---------|----------|--------|
| Criar OS | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Editar OS | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úèÔ∏è | ‚ùå |
| Deletar OS | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Movimentar Kanban | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| For√ßar Avan√ßo (sem checklist) | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Fazer Diagn√≥stico | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Criar Or√ßamento | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úèÔ∏è | ‚ùå |
| Aprovar Qualidade | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |

---

## üìä M√©tricas de Performance

### Por Etapa
- Tempo m√©dio em cada etapa
- Gargalos identificados
- Compara√ß√£o com metas

### Por T√©cnico
- OS finalizadas no per√≠odo
- Tempo m√©dio de execu√ß√£o
- Taxa de retrabalho

### Por Tipo de Servi√ßo
- Ret√≠ficas completas: X dias
- Diagn√≥sticos: Y dias
- Reparos espec√≠ficos: Z dias

---

**√öltima Atualiza√ß√£o**: 2025-01-14  
**Vers√£o**: 1.0.0
