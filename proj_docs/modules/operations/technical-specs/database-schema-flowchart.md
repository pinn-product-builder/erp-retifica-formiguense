# Fluxograma do Schema de Banco de Dados - M√≥dulo Opera√ß√µes & Servi√ßos

Este documento apresenta a arquitetura completa do banco de dados implementada para o m√≥dulo de Opera√ß√µes & Servi√ßos, organizada por fases de implementa√ß√£o.

## üèóÔ∏è Vis√£o Geral da Arquitetura

O sistema foi implementado em **5 fases distintas**, totalizando **31 novas tabelas** que se integram com as tabelas existentes do sistema.

<lov-mermaid>
graph TB
    %% FASE 1: FUNDA√á√ÉO DIN√ÇMICA
    subgraph "üéØ FASE 1: Funda√ß√£o Din√¢mica"
        ET[engine_types<br/>Tipos de Motor<br/>Configur√°veis]
        WS[workflow_steps<br/>Etapas de Workflow<br/>Personaliz√°veis]
        EFT[entry_form_templates<br/>Templates de<br/>Formul√°rios]
        EFF[entry_form_fields<br/>Campos Din√¢micos<br/>dos Formul√°rios]
        EFS[entry_form_submissions<br/>Formul√°rios<br/>Preenchidos]
        
        ET --> WS
        ET --> EFT
        EFT --> EFF
        EFT --> EFS
    end

    %% FASE 2: DIAGN√ìSTICO E OR√áAMENTA√á√ÉO
    subgraph "üîç FASE 2: Diagn√≥stico e Or√ßamenta√ß√£o"
        DC[diagnostic_checklists<br/>Checklists de<br/>Diagn√≥stico]
        DCI[diagnostic_checklist_items<br/>Itens dos<br/>Checklists]
        DCR[diagnostic_checklist_responses<br/>Respostas dos<br/>Diagn√≥sticos]
        DB[detailed_budgets<br/>Or√ßamentos<br/>Detalhados]
        BA[budget_approvals<br/>Aprova√ß√µes de<br/>Or√ßamento]
        BAL[budget_alerts<br/>Alertas de<br/>Or√ßamentos]
        SPT[service_price_table<br/>Tabela de Pre√ßos<br/>de Servi√ßos]
        PPT[parts_price_table<br/>Tabela de Pre√ßos<br/>de Pe√ßas]
        
        ET --> DC
        DC --> DCI
        DC --> DCR
        DCR --> DB
        DB --> BA
        BA --> BAL
        ET --> SPT
        SPT --> DB
        PPT --> DB
    end

    %% FASE 3: GEST√ÉO DE MATERIAIS
    subgraph "üì¶ FASE 3: Gest√£o de Materiais"
        PR[parts_reservations<br/>Reservas de<br/>Pe√ßas]
        PN[purchase_needs<br/>Necessidades de<br/>Compra]
        SS[supplier_suggestions<br/>Sugest√µes de<br/>Fornecedores]
        SPH[supplier_performance_history<br/>Hist√≥rico de Performance<br/>dos Fornecedores]
        SA[stock_alerts<br/>Alertas de<br/>Estoque]
        PSC[parts_stock_config<br/>Configura√ß√µes de<br/>Estoque]
        
        BA --> PR
        PR --> PN
        PN --> SS
        SS --> SPH
        PR --> SA
        SA --> PSC
    end

    %% FASE 4: CONTROLE DE QUALIDADE
    subgraph "üéØ FASE 4: Controle de Qualidade"
        WC[workflow_checklists<br/>Checklists de<br/>Qualidade]
        WCI[workflow_checklist_items<br/>Itens dos Checklists<br/>de Qualidade]
        WCR[workflow_checklist_responses<br/>Respostas dos<br/>Checklists]
        TR[technical_reports<br/>Relat√≥rios<br/>T√©cnicos]
        TRT[technical_report_templates<br/>Templates de<br/>Relat√≥rios]
        TSC[technical_standards_config<br/>Configura√ß√£o de<br/>Normas T√©cnicas]
        QH[quality_history<br/>Hist√≥rico de<br/>Qualidade]
        
        WS --> WC
        WC --> WCI
        WC --> WCR
        WCR --> TR
        TSC --> TRT
        TRT --> TR
        WCR --> QH
        TR --> QH
    end

    %% FASE 5: WORKFLOWS ESPECIALIZADOS
    subgraph "üõ°Ô∏è FASE 5: Workflows Especializados"
        WCL[warranty_claims<br/>Reclama√ß√µes de<br/>Garantia]
        SE[special_environments<br/>Ambientes<br/>Especiais]
        ER[environment_reservations<br/>Reservas de<br/>Ambientes]
        WI[warranty_indicators<br/>Indicadores de<br/>Garantia]
        
        WCL --> WI
        SE --> ER
        WS --> ER
    end

    %% COMPLEMENTAR
    subgraph "üìà Complementar"
        PER[purchase_efficiency_reports<br/>Relat√≥rios de Efici√™ncia<br/>de Compras]
        
        PN --> PER
        SS --> PER
    end

    %% TABELAS EXISTENTES (INTEGRA√á√ÉO)
    subgraph "üè¢ Sistema Existente"
        ORG[organizations<br/>Organiza√ß√µes]
        ORD[orders<br/>Ordens de<br/>Servi√ßo]
        OW[order_workflow<br/>Workflow das<br/>Ordens]
        ENG[engines<br/>Motores]
        CUST[customers<br/>Clientes]
        PI[parts_inventory<br/>Estoque de<br/>Pe√ßas]
        AR[accounts_receivable<br/>Contas a<br/>Receber]
        SC[status_config<br/>Configura√ß√£o<br/>de Status]
        
        ORG --> ET
        ORD --> DCR
        ORD --> DB
        ORD --> PR
        ORD --> WCR
        ORD --> TR
        ORD --> WCL
        OW --> WCR
        ENG --> ET
        CUST --> WCL
        PI --> PR
        BA --> AR
        SC --> WS
    end

    %% ESTILOS
    classDef fase1 fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef fase2 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef fase3 fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef fase4 fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef fase5 fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef existing fill:#f5f5f5,stroke:#424242,stroke-width:2px
    classDef complement fill:#e0f2f1,stroke:#00695c,stroke-width:2px

    class ET,WS,EFT,EFF,EFS fase1
    class DC,DCI,DCR,DB,BA,BAL,SPT,PPT fase2
    class PR,PN,SS,SPH,SA,PSC fase3
    class WC,WCI,WCR,TR,TRT,TSC,QH fase4
    class WCL,SE,ER,WI fase5
    class ORG,ORD,OW,ENG,CUST,PI,AR,SC existing
    class PER complement
</lov-mermaid>

## üìä Detalhamento por Fase

### üéØ FASE 1: Funda√ß√£o Din√¢mica (5 tabelas)
**Objetivo**: Criar base configur√°vel para workflows din√¢micos

| Tabela | Fun√ß√£o | Relacionamentos Principais |
|--------|---------|----------------------------|
| `engine_types` | Tipos de motor configur√°veis por organiza√ß√£o | ‚Üí `workflow_steps`, `diagnostic_checklists` |
| `workflow_steps` | Etapas personaliz√°veis por tipo de motor | ‚Üê `engine_types`, ‚Üí `workflow_checklists` |
| `entry_form_templates` | Templates de formul√°rios din√¢micos | ‚Üí `entry_form_fields` |
| `entry_form_fields` | Campos configur√°veis dos formul√°rios | ‚Üê `entry_form_templates` |
| `entry_form_submissions` | Dados coletados dos formul√°rios | ‚Üê `entry_form_templates`, ‚Üê `orders` |

### üîç FASE 2: Diagn√≥stico e Or√ßamenta√ß√£o (8 tabelas)
**Objetivo**: Sistema inteligente de diagn√≥stico e or√ßamenta√ß√£o autom√°tica

| Tabela | Fun√ß√£o | Relacionamentos Principais |
|--------|---------|----------------------------|
| `diagnostic_checklists` | Checklists por tipo de motor/componente | ‚Üê `engine_types`, ‚Üí `diagnostic_checklist_items` |
| `diagnostic_checklist_items` | Itens com triggers de servi√ßos | ‚Üê `diagnostic_checklists` |
| `diagnostic_checklist_responses` | Diagn√≥sticos preenchidos | ‚Üê `orders`, ‚Üí `detailed_budgets` |
| `detailed_budgets` | Or√ßamentos com c√°lculo autom√°tico | ‚Üê `orders`, ‚Üí `budget_approvals` |
| `budget_approvals` | Aprova√ß√µes documentadas | ‚Üê `detailed_budgets`, ‚Üí `accounts_receivable` |
| `budget_alerts` | Sistema de alertas de or√ßamentos | ‚Üê `detailed_budgets` |
| `service_price_table` | Pre√ßos de servi√ßos por tipo de motor | ‚Üê `engine_types` |
| `parts_price_table` | Pre√ßos de pe√ßas para c√°lculo autom√°tico | ‚Üê `organizations` |

### üì¶ FASE 3: Gest√£o de Materiais (6 tabelas)
**Objetivo**: Reserva autom√°tica e controle inteligente de compras

| Tabela | Fun√ß√£o | Relacionamentos Principais |
|--------|---------|----------------------------|
| `parts_reservations` | Reservas autom√°ticas por OS aprovada | ‚Üê `budget_approvals`, ‚Üê `parts_inventory` |
| `purchase_needs` | Necessidades identificadas automaticamente | ‚Üê `parts_reservations` |
| `supplier_suggestions` | Sugest√µes baseadas em hist√≥rico | ‚Üê `purchase_needs`, ‚Üê `suppliers` |
| `supplier_performance_history` | Performance para an√°lise inteligente | ‚Üê `suppliers` |
| `stock_alerts` | Alertas de estoque m√≠nimo/m√°ximo | ‚Üê `parts_inventory` |
| `parts_stock_config` | Configura√ß√µes de estoque por pe√ßa | ‚Üê `organizations` |

### üéØ FASE 4: Controle de Qualidade (7 tabelas)
**Objetivo**: Checklists de qualidade e relat√≥rios t√©cnicos autom√°ticos

| Tabela | Fun√ß√£o | Relacionamentos Principais |
|--------|---------|----------------------------|
| `workflow_checklists` | Checklists obrigat√≥rios por etapa | ‚Üê `workflow_steps` |
| `workflow_checklist_items` | Itens com medi√ß√µes e toler√¢ncias | ‚Üê `workflow_checklists` |
| `workflow_checklist_responses` | Preenchimento com valida√ß√µes | ‚Üê `order_workflow`, ‚Üí `technical_reports` |
| `technical_reports` | Relat√≥rios gerados automaticamente | ‚Üê `orders`, ‚Üê `workflow_checklist_responses` |
| `technical_report_templates` | Templates por norma t√©cnica | ‚Üê `organizations` |
| `technical_standards_config` | Normas t√©cnicas (NBR 13032, Bosch RAM) | ‚Üê `organizations` |
| `quality_history` | Auditoria completa de qualidade | ‚Üê `orders`, ‚Üê `workflow_checklist_responses` |

### üõ°Ô∏è FASE 5: Workflows Especializados (4 tabelas)
**Objetivo**: Sistema de garantia e workflow Bosch especializado

| Tabela | Fun√ß√£o | Relacionamentos Principais |
|--------|---------|----------------------------|
| `warranty_claims` | Reclama√ß√µes com avalia√ß√£o t√©cnica | ‚Üê `orders`, ‚Üê `customers`, ‚Üí `orders` (nova OS) |
| `special_environments` | Controle de ambientes (Sala Limpa Bosch) | ‚Üê `organizations` |
| `environment_reservations` | Reservas de ambientes especiais | ‚Üê `special_environments`, ‚Üê `orders` |
| `warranty_indicators` | Indicadores de garantia por per√≠odo | ‚Üê `organizations` |

### üìà Complementar (1 tabela)
| Tabela | Fun√ß√£o | Relacionamentos Principais |
|--------|---------|----------------------------|
| `purchase_efficiency_reports` | Relat√≥rios de efici√™ncia de compras | ‚Üê `purchase_needs`, ‚Üê `supplier_suggestions` |

## üîÑ Fluxos de Automa√ß√£o Implementados

### 1. **Fluxo de Or√ßamenta√ß√£o Autom√°tica**
```
Diagn√≥stico ‚Üí Checklist Preenchido ‚Üí Servi√ßos Gerados ‚Üí Or√ßamento Calculado ‚Üí Aprova√ß√£o ‚Üí Conta a Receber
```

### 2. **Fluxo de Reserva de Materiais**
```
Or√ßamento Aprovado ‚Üí Verifica√ß√£o de Estoque ‚Üí Reserva Autom√°tica ‚Üí Alerta de Compra (se necess√°rio)
```

### 3. **Fluxo de Controle de Qualidade**
```
Etapa do Workflow ‚Üí Checklist Obrigat√≥rio ‚Üí Preenchimento ‚Üí Relat√≥rio T√©cnico Autom√°tico ‚Üí Hist√≥rico de Qualidade
```

### 4. **Fluxo de Garantia**
```
Reclama√ß√£o ‚Üí Avalia√ß√£o T√©cnica ‚Üí Aprova√ß√£o ‚Üí OS de Garantia (Prioridade Alta) ‚Üí Workflow Especializado
```

### 5. **Fluxo Bosch Especializado**
```
Motor Bosch ‚Üí 14 Etapas Obrigat√≥rias ‚Üí Ambiente Controlado ‚Üí Certifica√ß√£o ‚Üí Relat√≥rio Bosch RAM
```

## üöÄ Funcionalidades Implementadas

### **Automa√ß√µes Cr√≠ticas:**
- ‚úÖ **Gera√ß√£o autom√°tica de n√∫meros** para todos os documentos
- ‚úÖ **Reserva autom√°tica de pe√ßas** quando or√ßamento aprovado
- ‚úÖ **Cria√ß√£o autom√°tica de contas a receber**
- ‚úÖ **Gera√ß√£o autom√°tica de relat√≥rios t√©cnicos**
- ‚úÖ **Alertas inteligentes de estoque**
- ‚úÖ **Cria√ß√£o de OS de garantia com prioridade**
- ‚úÖ **Bloqueio de workflow** se checklist obrigat√≥rio n√£o completado

### **Intelig√™ncia de Neg√≥cio:**
- üß† **Sugest√£o inteligente de fornecedores** baseada em hist√≥rico
- üß† **Identifica√ß√£o autom√°tica de necessidades de compra**
- üß† **C√°lculo autom√°tico de performance de fornecedores**
- üß† **An√°lise de efici√™ncia de compras** (planejada vs emergencial)
- üß† **Indicadores de garantia** por per√≠odo e componente

### **Seguran√ßa e Performance:**
- üîí **31 pol√≠ticas RLS** implementadas
- ‚ö° **65+ √≠ndices** para consultas otimizadas
- üìù **15 triggers** para automa√ß√µes
- üîß **12 fun√ß√µes PL/pgSQL** para l√≥gicas complexas

---

## üìã Status da Implementa√ß√£o

| Fase | Tabelas | Status | Funcionalidades |
|------|---------|--------|-----------------|
| **Fase 1** | 5/5 | ‚úÖ **Completa** | Workflows din√¢micos configur√°veis |
| **Fase 2** | 8/8 | ‚úÖ **Completa** | Diagn√≥stico e or√ßamenta√ß√£o inteligente |
| **Fase 3** | 6/6 | ‚úÖ **Completa** | Gest√£o inteligente de materiais |
| **Fase 4** | 7/7 | ‚úÖ **Completa** | Controle de qualidade automatizado |
| **Fase 5** | 4/4 | ‚úÖ **Completa** | Workflows especializados e garantia |
| **Complementar** | 1/1 | ‚úÖ **Completa** | Relat√≥rios de efici√™ncia |
| **TOTAL** | **31/31** | ‚úÖ **100%** | **Sistema completo implementado** |

---

*√öltima atualiza√ß√£o: 23/09/2025*
